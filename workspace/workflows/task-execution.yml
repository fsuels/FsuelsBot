# Task Execution Workflow
# How to handle any task from Francisco

workflow:
  id: WF-TASK
  name: Task Execution
  description: Standard flow for executing any task from Francisco
  version: 1

states:
  - id: received
    name: Task Received
    type: start
    description: Francisco has given a task

  - id: analyzing
    name: Analyzing
    type: intermediate
    description: Understanding what needs to be done

  - id: planning
    name: Planning
    type: intermediate
    description: Breaking down into steps

  - id: executing
    name: Executing
    type: intermediate
    description: Doing the work

  - id: verifying
    name: Verifying
    type: intermediate
    description: Checking the work is correct

  - id: reporting
    name: Reporting
    type: intermediate
    description: Telling Francisco what was done

  - id: completed
    name: Completed
    type: end
    description: Task finished successfully

  - id: blocked
    name: Blocked
    type: error
    description: Cannot proceed, need input

  - id: failed
    name: Failed
    type: error
    description: Task failed, need to recover

transitions:
  - from: received
    to: analyzing
    trigger: automatic
    actions:
      - Read task description
      - Check CONSTITUTION.md for constraints
      - Identify task type

  - from: analyzing
    to: planning
    trigger: task_understood
    conditions:
      - Task is clear
      - No constitutional violations
    actions:
      - Break into steps
      - Estimate complexity
      - Update state.json

  - from: analyzing
    to: blocked
    trigger: need_clarification
    conditions:
      - Task is ambiguous
    actions:
      - Ask Francisco for clarification
      - Wait for response

  - from: planning
    to: executing
    trigger: plan_ready
    conditions:
      - Steps are clear
      - Resources available
    actions:
      - Start first step
      - Update state.json with current step

  - from: executing
    to: executing
    trigger: step_complete
    conditions:
      - More steps remain
    actions:
      - Log completed step
      - Start next step
      - Update state.json

  - from: executing
    to: verifying
    trigger: all_steps_complete
    actions:
      - Review all completed steps
      - Check outcomes match expectations

  - from: executing
    to: blocked
    trigger: step_blocked
    conditions:
      - Need external input or resource
    actions:
      - Report what's blocking
      - Ask for help

  - from: executing
    to: failed
    trigger: step_failed
    conditions:
      - Unrecoverable error
    actions:
      - Log failure in incidents/
      - Report to Francisco

  - from: verifying
    to: reporting
    trigger: verification_passed
    actions:
      - Summarize what was done
      - Prepare report for Francisco

  - from: verifying
    to: executing
    trigger: verification_failed
    actions:
      - Identify what needs fixing
      - Add corrective steps

  - from: reporting
    to: completed
    trigger: report_delivered
    actions:
      - Update state.json status to complete
      - Log to events.jsonl
      - Clear currentTask or start next

  - from: blocked
    to: executing
    trigger: unblocked
    conditions:
      - Received needed input
    actions:
      - Resume from blocked step

  - from: failed
    to: analyzing
    trigger: retry_approved
    conditions:
      - Francisco approves retry
    actions:
      - Log retry in events.jsonl
      - Re-analyze with lessons learned

resume_protocol:
  description: How to resume after context compaction
  steps:
    - Read state.json to get current_state
    - Read current workflow file
    - Find valid next transitions
    - Continue from current state
