# Memory Update Workflow
# How to safely update memory state

workflow:
  id: WF-MEMORY
  name: Memory State Update
  description: Protocol for updating state.json, events.jsonl, and AGENTS.md
  version: 1

states:
  - id: triggered
    name: Update Triggered
    type: start
    description: Something happened that needs to be remembered

  - id: validating
    name: Validating Change
    type: intermediate
    description: Check the update is valid

  - id: updating_state
    name: Updating state.json
    type: intermediate
    description: Write to authoritative source

  - id: logging_event
    name: Logging Event
    type: intermediate
    description: Append to events.jsonl

  - id: rendering
    name: Rendering AGENTS.md
    type: intermediate
    description: Update the CURRENT STATE section

  - id: completed
    name: Update Complete
    type: end
    description: Memory successfully updated

  - id: failed
    name: Update Failed
    type: error
    description: Something went wrong

transitions:
  - from: triggered
    to: validating
    trigger: automatic
    actions:
      - Parse the update
      - Check it matches state.json schema

  - from: validating
    to: updating_state
    trigger: valid
    conditions:
      - Update is well-formed
      - Does not violate CONSTITUTION.md
    actions:
      - Read current state.json
      - Merge changes
      - Increment version

  - from: validating
    to: failed
    trigger: invalid
    actions:
      - Log validation error
      - Do not modify any files

  - from: updating_state
    to: logging_event
    trigger: state_written
    conditions:
      - state.json write successful
    actions:
      - Create event object
      - Include timestamp, event type, summary

  - from: logging_event
    to: rendering
    trigger: event_logged
    conditions:
      - events.jsonl append successful
    actions:
      - Read state.json
      - Format CURRENT STATE section
      - Prepare AGENTS.md edit

  - from: rendering
    to: completed
    trigger: render_complete
    actions:
      - Verify all three files updated
      - Log success

  - from: updating_state
    to: failed
    trigger: write_error
    actions:
      - Log error
      - Attempt rollback if possible

  - from: logging_event
    to: failed
    trigger: append_error
    actions:
      - Log error (state.json is updated but event not logged)
      - Flag inconsistency

  - from: rendering
    to: failed
    trigger: render_error
    actions:
      - Log error (state + events updated, render failed)
      - Manual intervention needed

consistency_rules:
  - state.json is the source of truth
  - events.jsonl is append-only, never edit
  - AGENTS.md CURRENT STATE is a render, always regenerate from state.json
  - If files are inconsistent, trust state.json > events.jsonl > AGENTS.md
