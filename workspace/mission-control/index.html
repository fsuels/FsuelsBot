<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mission Control ‚Äî DLM Command Center</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #21262d;
    --border: #30363d;
    --text: #e6edf3;
    --text-dim: #8b949e;
    --accent: #58a6ff;
    --critical: #f85149;
    --high: #f0883e;
    --medium: #d29922;
    --low: #3fb950;
    --blocked: #f85149;
    --todo: #58a6ff;
    --progress: #d29922;
    --done: #3fb950;
  }

  /* === RESET & BASE === */
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
  html, body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    -webkit-text-size-adjust: 100%;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
  }

  /* === LAYOUT SHELL (fixed viewport) === */
  #app {
    display: flex;
    flex-direction: column;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
  }

  /* === HEADER === */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 6px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    flex-shrink: 0;
    min-height: 40px;
  }
  header h1 {
    font-size: 15px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
  }
  header h1 .rocket { font-size: 18px; }
  header h1 .subtitle { font-size: 12px; color: var(--text-dim); font-weight: 400; }
  .header-right {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: nowrap;
  }
  #clawdStatus {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: var(--surface2);
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    white-space: nowrap;
    border: 1px solid transparent;
  }
  #clawdStatus:hover { border-color: var(--border); }
  #statusDot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #888;
    flex-shrink: 0;
  }
  #gatewayLink {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: var(--surface2);
    border-radius: 6px;
    font-size: 12px;
    color: var(--accent);
    text-decoration: none;
    border: 1px solid var(--border);
    white-space: nowrap;
  }
  #gatewayLink:hover { background: var(--border); }
  .tabs {
    display: flex;
    gap: 2px;
    background: var(--surface2);
    border-radius: 8px;
    padding: 3px;
  }
  .tab {
    padding: 5px 14px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tab:hover { color: var(--text); background: rgba(255,255,255,0.06); }
  .tab.active { background: var(--accent); color: #fff; }

  /* === STATS BAR === */
  .stats-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 5px 12px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    flex-shrink: 0;
    flex-wrap: wrap;
  }
  .stat {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .stat-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .stat-label { color: var(--text-dim); }
  .stat-value { font-weight: 700; font-size: 14px; }
  .updated { margin-left: auto; color: var(--text-dim); font-style: italic; font-size: 11px; }

  /* === KANBAN VIEW === */
  .kanban {
    display: none;
    flex: 1;
    overflow: hidden;
    background: var(--bg);
  }
  .kanban.active {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    padding: 6px;
  }
  .column {
    min-width: 0;
    background: var(--surface);
    border-radius: 8px;
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .column-header {
    padding: 10px 12px;
    font-weight: 700;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .column-header .count {
    background: var(--surface2);
    border-radius: 12px;
    padding: 2px 10px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-dim);
  }
  .column-body {
    padding: 6px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex: 1;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .column-body::-webkit-scrollbar { width: 5px; }
  .column-body::-webkit-scrollbar-track { background: transparent; }
  .column-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 5px; }

  /* === CARDS === */
  .card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    cursor: pointer;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  .card:hover { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(88,166,255,0.15); }
  .card-id {
    font-size: 11px;
    color: var(--text-dim);
    font-family: 'SFMono-Regular', Consolas, monospace;
    letter-spacing: 0.3px;
  }
  .card-title {
    font-size: 14px;
    font-weight: 600;
    margin: 3px 0 8px;
    line-height: 1.35;
    color: var(--text);
  }
  .card-desc {
    font-size: 13px;
    color: var(--text-dim);
    line-height: 1.5;
    margin-bottom: 8px;
    display: none;
  }
  .card.expanded .card-desc { display: block; }

  /* Benefit box */
  .card-benefit {
    display: none;
    margin-top: 10px;
    padding: 10px 12px;
    background: rgba(63,185,80,0.08);
    border-radius: 6px;
    border-left: 3px solid var(--done);
    font-size: 13px;
    font-weight: 500;
    color: var(--done);
    line-height: 1.5;
  }
  .card.expanded .card-benefit { display: block; }

  /* Details box */
  .card-details {
    display: none;
    margin-top: 8px;
    padding: 10px 12px;
    background: rgba(0,0,0,0.25);
    border-radius: 6px;
    border-left: 3px solid var(--accent);
    font-size: 13px;
    color: var(--text);
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 400px;
    overflow-y: auto;
  }
  .card.expanded .card-details { display: block; }

  .card-expand-hint {
    font-size: 11px;
    color: var(--accent);
    text-align: right;
    margin-top: 4px;
    opacity: 0.7;
  }
  .card.expanded .card-expand-hint { display: none; }

  /* Meta row: badges + tags */
  .card-meta {
    display: flex;
    align-items: center;
    gap: 5px;
    flex-wrap: wrap;
    padding-bottom: 2px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    margin-bottom: 2px;
  }
  .priority-badge {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    padding: 2px 7px;
    border-radius: 4px;
    letter-spacing: 0.4px;
  }
  .priority-critical { background: rgba(248,81,73,0.2); color: var(--critical); }
  .priority-high { background: rgba(240,136,62,0.2); color: var(--high); }
  .priority-medium { background: rgba(210,153,34,0.2); color: var(--medium); }
  .priority-low { background: rgba(63,185,80,0.2); color: var(--low); }
  .assignee-badge {
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 4px;
    background: rgba(88,166,255,0.12);
    color: var(--accent);
    font-weight: 500;
  }
  .tag {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 3px;
    background: rgba(255,255,255,0.06);
    color: var(--text-dim);
  }
  .blocked-reason {
    font-size: 12px;
    color: var(--critical);
    margin-top: 6px;
    padding: 5px 8px;
    background: rgba(248,81,73,0.08);
    border-radius: 4px;
    border-left: 3px solid var(--critical);
    line-height: 1.4;
  }

  /* === SECOND BRAIN VIEW === */
  .brain { display: none; padding: 20px; overflow-y: auto; flex: 1; }
  .brain.active { display: block; }
  .brain-section { margin-bottom: 28px; }
  .brain-section h2 { font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .brain-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
  .brain-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px; transition: border-color 0.15s; }
  .brain-card:hover { border-color: var(--accent); }
  .brain-card h3 { font-size: 15px; font-weight: 600; margin-bottom: 8px; }
  .brain-card p { font-size: 14px; color: var(--text-dim); line-height: 1.5; }
  .brain-card .brain-tags { margin-top: 10px; display: flex; gap: 4px; flex-wrap: wrap; }
  .brain-card .brain-date { font-size: 11px; color: var(--text-dim); margin-top: 8px; }
  .idea-icon { color: #f0883e; }
  .research-icon { color: #58a6ff; }
  .insight-icon { color: #d2a8ff; }

  /* === SUMMARY VIEW === */
  .summary { display: none; padding: 20px; overflow-y: auto; flex: 1; max-width: 1000px; }
  .summary.active { display: block; }
  .summary h2 { font-size: 18px; margin-bottom: 16px; }
  .summary-block { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px 20px; margin-bottom: 14px; }
  .summary-block h3 { font-size: 15px; margin-bottom: 12px; color: var(--accent); }
  .summary-block ul { list-style: none; padding: 0; }
  .summary-block li { padding: 6px 0; font-size: 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
  .summary-block li:last-child { border: none; }

  /* === ACTIVITY VIEW === */
  .activity { display: none; padding: 16px; overflow-y: auto; flex: 1; }
  .activity.active { display: flex; flex-direction: column; gap: 16px; }

  .activity-hero {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 24px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
  }
  .status-orb {
    width: 80px; height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    flex-shrink: 0;
    position: relative;
  }
  .status-orb.idle { background: rgba(139,148,158,0.15); }
  .status-orb.working { background: rgba(63,185,80,0.15); animation: pulse-green 2s infinite; }
  .status-orb.thinking { background: rgba(88,166,255,0.15); animation: pulse-blue 1.5s infinite; }
  @keyframes pulse-green {
    0%, 100% { box-shadow: 0 0 0 0 rgba(63,185,80,0.4); }
    50% { box-shadow: 0 0 20px 10px rgba(63,185,80,0.15); }
  }
  @keyframes pulse-blue {
    0%, 100% { box-shadow: 0 0 0 0 rgba(88,166,255,0.4); }
    50% { box-shadow: 0 0 20px 10px rgba(88,166,255,0.15); }
  }
  .status-info h2 { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
  .status-info .task-label { font-size: 15px; color: var(--text-dim); }
  .status-info .since { font-size: 12px; color: var(--text-dim); margin-top: 4px; }

  .activity-body { display: flex; gap: 16px; flex: 1; min-height: 0; }

  .activity-feed {
    flex: 2;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .feed-header {
    padding: 12px 16px;
    font-weight: 700;
    font-size: 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }
  .feed-header .live-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #3fb950;
    animation: blink 1.5s infinite;
  }
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
  .feed-body {
    padding: 8px;
    overflow-y: auto;
    flex: 1;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .feed-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 6px;
    transition: background 0.15s;
    font-size: 13px;
  }
  .feed-item:hover { background: rgba(255,255,255,0.03); }
  .feed-item .fi-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
  .feed-item .fi-time {
    font-size: 11px;
    color: var(--text-dim);
    font-family: 'SFMono-Regular', Consolas, monospace;
    flex-shrink: 0;
    min-width: 65px;
  }
  .feed-item .fi-msg { color: var(--text); line-height: 1.4; word-break: break-word; }
  .feed-item.error-item { background: rgba(248,81,73,0.06); }
  .feed-item.error-item .fi-msg { color: var(--critical); }

  .activity-sidebar {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-width: 220px;
  }
  .activity-stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
  }
  .activity-stat-card h3 {
    font-size: 12px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }
  .activity-stat-card .big-num {
    font-size: 32px;
    font-weight: 700;
  }
  .activity-stat-card .sub-text {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  /* === MOBILE (phones only) === */
  @media (max-width: 600px) {
    header { flex-wrap: wrap; padding: 8px; gap: 6px; }
    header h1 { font-size: 14px; }
    .header-right { flex-wrap: wrap; width: 100%; justify-content: center; }
    .tab { padding: 6px 8px; font-size: 11px; }
    .stats-bar { flex-wrap: wrap; gap: 8px; padding: 6px 8px; justify-content: center; }
    .updated { width: 100%; text-align: center; margin-left: 0; }
    .kanban.active {
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 8px;
      overflow-y: auto;
    }
    .column-body { overflow-y: visible; }
    .card { padding: 14px; }
    .card-title { font-size: 15px; }
    .brain-grid { grid-template-columns: 1fr; }
    .activity-hero { flex-direction: column; text-align: center; padding: 16px; }
    .status-orb { width: 60px; height: 60px; font-size: 28px; }
    .activity-body { flex-direction: column; }
    .activity-sidebar { flex-direction: row; flex-wrap: wrap; }
    .activity-stat-card { flex: 1; min-width: 140px; }
  }

  /* Touch devices */
  @media (pointer: coarse) {
    .card { padding: 12px 14px; min-height: 44px; }
    .tab { min-height: 40px; }
  }
</style>
</head>
<body>
<div id="app">

<header>
  <h1>
    <span class="rocket">üöÄ</span>
    Mission Control
    <span class="subtitle">‚Äî Dress Like Mommy</span>
  </h1>
  <div class="header-right">
    <div id="clawdStatus" onclick="checkStatus()">
      <span id="statusDot"></span>
      <span id="statusText" style="color:var(--text-dim);">Checking...</span>
    </div>
    <a href="http://127.0.0.1:18789/overview" target="_blank" rel="noopener" id="gatewayLink" onclick="event.preventDefault(); window.open(this.href, 'gateway', 'noopener,noreferrer');">‚öôÔ∏è Gateway</a>
    <div class="tabs">
      <button class="tab" onclick="switchView('activity', event)">‚ö° Activity</button>
      <button class="tab active" onclick="switchView('kanban', event)">üìã Kanban</button>
      <button class="tab" onclick="switchView('brain', event)">üß† Brain</button>
      <button class="tab" onclick="switchView('summary', event)">üìä Summary</button>
    </div>
  </div>
</header>

<div class="stats-bar" id="statsBar"></div>

<div class="activity" id="activityView"></div>
<div class="kanban active" id="kanbanView"></div>
<div class="brain" id="brainView"></div>
<div class="summary" id="summaryView"></div>

</div><!-- #app -->

<script>
let data = null;

function esc(s) {
  if (s == null) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

async function loadData() {
  try {
    const resp = await fetch('./data.json?' + Date.now());
    data = await resp.json();
  } catch(e) { data = window.__DATA__; }
  render();
}

function switchView(view, e) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  e.target.classList.add('active');
  document.getElementById('activityView').classList.toggle('active', view === 'activity');
  document.getElementById('kanbanView').classList.toggle('active', view === 'kanban');
  document.getElementById('brainView').classList.toggle('active', view === 'brain');
  document.getElementById('summaryView').classList.toggle('active', view === 'summary');
  if (view === 'activity') startActivityPolling();
  else stopActivityPolling();
}

function renderCard(task) {
  const blocked = task.blockedReason ? `<div class="blocked-reason">‚õî ${esc(task.blockedReason)}</div>` : '';
  const assigneeLabel = task.assignee === 'clawd' ? 'ü§ñ Clawd' : task.assignee === 'francisco' ? 'üë§ Francisco' : 'üë• Both';
  const tags = (task.tags || []).slice(0, 4).map(t => `<span class="tag">${esc(t)}</span>`).join('');
  const benefit = task.benefit ? `<div class="card-benefit">${esc(task.benefit)}</div>` : '';
  const details = task.details ? `<div class="card-details">${esc(task.details)}</div>` : '';
  const completed = task.completed ? `<div style="font-size:12px;color:var(--done);margin-top:4px;">‚úÖ Completed: ${esc(task.completed)}</div>` : '';
  const hasMore = (task.details || task.benefit) ? '<div class="card-expand-hint">‚ñ∏ Click for details & business value</div>' : '';
  return `
    <div class="card" onclick="this.classList.toggle('expanded')">
      <div class="card-id">${esc(task.id)}${task.completed ? ' ‚úÖ' : ''}</div>
      <div class="card-title">${esc(task.title)}</div>
      <div class="card-meta">
        <span class="priority-badge priority-${esc(task.priority)}">${esc(task.priority)}</span>
        <span class="assignee-badge">${assigneeLabel}</span>
        ${tags}
      </div>
      ${blocked}
      ${completed}
      ${benefit}
      ${details}
      ${hasMore}
    </div>`;
}

function render() {
  if (!data) return;
  const cols = data.columns;
  const order = ['blocked', 'inProgress', 'todo', 'done'];
  const icons = { blocked: 'üö´', inProgress: 'üî®', todo: 'üìã', done: '‚úÖ' };
  const colors = { blocked: 'var(--blocked)', inProgress: 'var(--progress)', todo: 'var(--todo)', done: 'var(--done)' };

  let total = 0, critCount = 0, fCount = 0, cCount = 0;
  order.forEach(k => {
    (cols[k]?.tasks || []).forEach(t => {
      total++;
      if (t.priority === 'critical') critCount++;
      if (t.assignee === 'francisco') fCount++;
      if (t.assignee === 'clawd') cCount++;
    });
  });

  document.getElementById('statsBar').innerHTML = `
    <div class="stat"><span class="stat-value">${total}</span> <span class="stat-label">Total</span></div>
    <div class="stat"><div class="stat-dot" style="background:var(--critical)"></div><span class="stat-value">${critCount}</span> <span class="stat-label">Critical</span></div>
    <div class="stat"><div class="stat-dot" style="background:var(--accent)"></div><span class="stat-value">${cCount}</span> <span class="stat-label">Clawd</span></div>
    <div class="stat"><div class="stat-dot" style="background:var(--medium)"></div><span class="stat-value">${fCount}</span> <span class="stat-label">Francisco</span></div>
    <div class="stat"><div class="stat-dot" style="background:var(--done)"></div><span class="stat-value">${(cols.done?.tasks||[]).length}</span> <span class="stat-label">Done</span></div>
    <div class="updated">Updated: ${new Date(data.lastUpdated).toLocaleString()}</div>
  `;

  let kanbanHTML = '';
  order.forEach(k => {
    const col = cols[k];
    if (!col) return;
    const tasks = col.tasks || [];
    kanbanHTML += `
      <div class="column">
        <div class="column-header" style="border-left: 3px solid ${colors[k]}">
          ${icons[k]} ${esc(col.label)} <span class="count">${tasks.length}</span>
        </div>
        <div class="column-body">
          ${tasks.map(t => renderCard(t)).join('')}
        </div>
      </div>`;
  });
  document.getElementById('kanbanView').innerHTML = kanbanHTML;

  // Second Brain
  const sb = data.secondBrain || {};
  let brainHTML = '';
  ['ideas','research','insights'].forEach(type => {
    const items = sb[type];
    if (!items?.length) return;
    const icons = { ideas: 'üí°', research: 'üî¨', insights: '‚ú®' };
    const labels = { ideas: 'Ideas', research: 'Research', insights: 'Insights' };
    brainHTML += `<div class="brain-section"><h2>${icons[type]} ${labels[type]}</h2><div class="brain-grid">`;
    items.forEach(item => {
      brainHTML += `<div class="brain-card"><h3>${esc(item.title)}</h3><p>${esc(item.description)}</p>
        <div class="brain-tags">${(item.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join('')}</div>
        <div class="brain-date">${esc(item.created)}</div></div>`;
    });
    brainHTML += '</div></div>';
  });
  document.getElementById('brainView').innerHTML = brainHTML;

  // Summary
  const todoTasks = cols.todo?.tasks || [];
  const blockedTasks = cols.blocked?.tasks || [];
  const progressTasks = cols.inProgress?.tasks || [];
  const doneTasks = cols.done?.tasks || [];
  const franciscoTasks = [...todoTasks, ...progressTasks, ...blockedTasks].filter(t => t.assignee === 'francisco' || t.assignee === 'both');
  const clawdTasks = [...todoTasks, ...progressTasks, ...blockedTasks].filter(t => t.assignee === 'clawd' || t.assignee === 'both');

  document.getElementById('summaryView').innerHTML = `
    <div class="summary-block"><h3>üî• Critical & In Progress (${progressTasks.length + blockedTasks.length})</h3><ul>
      ${[...progressTasks, ...blockedTasks].map(t => `<li><span class="priority-badge priority-${esc(t.priority)}">${esc(t.priority)}</span> ${esc(t.title)}</li>`).join('')}
    </ul></div>
    <div class="summary-block"><h3>üë§ Francisco's Items (${franciscoTasks.length})</h3><ul>
      ${franciscoTasks.map(t => `<li><span class="priority-badge priority-${esc(t.priority)}">${esc(t.priority)}</span> ${esc(t.title)}</li>`).join('')}
    </ul></div>
    <div class="summary-block"><h3>ü§ñ Clawd's Queue (${clawdTasks.length})</h3><ul>
      ${clawdTasks.map(t => `<li><span class="priority-badge priority-${esc(t.priority)}">${esc(t.priority)}</span> ${esc(t.title)}</li>`).join('')}
    </ul></div>
    <div class="summary-block"><h3>‚úÖ Completed (${doneTasks.length})</h3><ul>
      ${doneTasks.slice(0,8).map(t => `<li>‚úÖ ${esc(t.title)} <span style="color:var(--text-dim);font-size:12px">${esc(t.completed||'')}</span></li>`).join('')}
    </ul></div>
  `;
}

loadData();

// === Clawdbot Status ===
async function checkStatus() {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  try {
    const resp = await fetch('/api/status', {signal: AbortSignal.timeout(4000)});
    const d = await resp.json();
    if (d.online) {
      dot.style.background = '#3fb950';
      const h = Math.floor((d.uptime||0)/3600), m = Math.floor(((d.uptime||0)%3600)/60);
      const up = h > 24 ? Math.floor(h/24)+'d' : h > 0 ? h+'h '+m+'m' : m+'m';
      text.style.color = '#3fb950';
      text.innerHTML = 'ü§ñ <b>Connected</b> ¬∑ ' + up;
    } else {
      dot.style.background = '#f85149';
      text.style.color = '#f85149';
      text.textContent = '‚ö†Ô∏è Disconnected';
    }
  } catch(e) {
    dot.style.background = '#f85149';
    text.style.color = '#f85149';
    text.textContent = '‚ö†Ô∏è Offline';
  }
}
checkStatus();
setInterval(checkStatus, 30000);

// === Activity Monitor ===
let activityInterval = null;

function startActivityPolling() {
  fetchActivity();
  if (!activityInterval) activityInterval = setInterval(fetchActivity, 3000);
}

function stopActivityPolling() {
  if (activityInterval) { clearInterval(activityInterval); activityInterval = null; }
}

function formatTime(isoStr) {
  if (!isoStr) return '';
  try {
    const d = new Date(isoStr);
    return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
  } catch { return ''; }
}

function timeAgo(isoStr) {
  if (!isoStr) return '';
  try {
    const now = Date.now();
    const then = new Date(isoStr).getTime();
    const diff = Math.floor((now - then) / 1000);
    if (diff < 60) return `${diff}s ago`;
    if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff/3600)}h ${Math.floor((diff%3600)/60)}m ago`;
    return `${Math.floor(diff/86400)}d ago`;
  } catch { return ''; }
}

function friendlyMessage(msg) {
  if (!msg) return '';
  // Clean up technical log messages for human readability
  return msg
    .replace(/runId=\S+/g, '')
    .replace(/sessionId=\S+/g, '')
    .replace(/toolCallId=\S+/g, '')
    .replace(/conn=\S+/g, '')
    .replace(/id=\S+/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}

async function fetchActivity() {
  try {
    const resp = await fetch('/api/activity?' + Date.now(), { signal: AbortSignal.timeout(5000) });
    const act = await resp.json();
    renderActivity(act);
  } catch (e) {
    renderActivityOffline();
  }
}

function renderActivityOffline() {
  document.getElementById('activityView').innerHTML = `
    <div class="activity-hero">
      <div class="status-orb idle">üí§</div>
      <div class="status-info">
        <h2 style="color:var(--text-dim);">Activity Server Offline</h2>
        <div class="task-label">Start the activity server to see live updates</div>
        <div class="since" style="margin-top:8px;font-family:monospace;color:var(--accent);">python mission-control/activity-server.py</div>
      </div>
    </div>`;
}

function renderActivity(act) {
  const statusIcons = { idle: 'üí§', working: '‚ö°', thinking: 'üß†' };
  const statusLabels = { idle: 'Idle', working: 'Working', thinking: 'Thinking' };
  const statusColors = { idle: 'var(--text-dim)', working: 'var(--done)', thinking: 'var(--accent)' };

  const icon = statusIcons[act.status] || '‚ùì';
  const label = statusLabels[act.status] || act.status;
  const color = statusColors[act.status] || 'var(--text)';
  const task = act.currentTask || 'Waiting for a task...';
  const tool = act.currentTool ? `üîß Tool: ${act.currentTool}` : '';

  // Feed items
  const feedItems = (act.recentEvents || []).slice(0, 30).map(ev => {
    const isError = ev.type === 'error';
    return `<div class="feed-item ${isError ? 'error-item' : ''}">
      <span class="fi-icon">${esc(ev.icon || '‚Ä¢')}</span>
      <span class="fi-time">${formatTime(ev.time)}</span>
      <span class="fi-msg">${esc(friendlyMessage(ev.message))}</span>
    </div>`;
  }).join('');

  const stats = act.stats || {};
  const session = act.sessionInfo || {};

  document.getElementById('activityView').innerHTML = `
    <div class="activity-hero">
      <div class="status-orb ${esc(act.status)}">
        ${icon}
      </div>
      <div class="status-info">
        <h2 style="color:${color};">${label}</h2>
        <div class="task-label">${esc(task)}</div>
        ${tool ? `<div class="task-label" style="margin-top:4px;font-size:13px;">${esc(tool)}</div>` : ''}
        <div class="since">Since ${timeAgo(act.statusSince)}</div>
      </div>
    </div>

    <div class="activity-body">
      <div class="activity-feed">
        <div class="feed-header">
          <span class="live-dot"></span>
          Live Activity Feed
          <span style="margin-left:auto;font-size:11px;color:var(--text-dim);">Updated ${timeAgo(act.lastUpdate)}</span>
        </div>
        <div class="feed-body">
          ${feedItems || '<div style="padding:20px;text-align:center;color:var(--text-dim);">No activity yet. Events will appear here as Clawdbot works.</div>'}
        </div>
      </div>

      <div class="activity-sidebar">
        <div class="activity-stat-card">
          <h3>üîß Tool Calls</h3>
          <div class="big-num" style="color:var(--accent);">${stats.toolCalls || 0}</div>
          <div class="sub-text">Since last restart</div>
        </div>
        <div class="activity-stat-card">
          <h3>üèÅ Runs Completed</h3>
          <div class="big-num" style="color:var(--done);">${stats.runsCompleted || 0}</div>
          <div class="sub-text">Requests processed</div>
        </div>
        <div class="activity-stat-card">
          <h3>‚ùå Errors Today</h3>
          <div class="big-num" style="color:${(stats.errorsToday || 0) > 0 ? 'var(--critical)' : 'var(--done)'};">${stats.errorsToday || 0}</div>
          ${stats.lastError ? `<div class="sub-text" style="color:var(--critical);margin-top:4px;">${esc(stats.lastError)}</div>` : '<div class="sub-text">All clear ‚úÖ</div>'}
        </div>
        <div class="activity-stat-card">
          <h3>ü§ñ Model</h3>
          <div style="font-size:15px;font-weight:600;color:var(--text);margin-top:4px;">${esc(session.model || 'unknown')}</div>
          <div class="sub-text">Provider: ${esc(session.provider || 'unknown')}</div>
        </div>
        <div class="activity-stat-card">
          <h3>‚è±Ô∏è Up Since</h3>
          <div style="font-size:14px;font-weight:600;color:var(--text);margin-top:4px;">${formatTime(stats.upSince)}</div>
          <div class="sub-text">${timeAgo(stats.upSince)}</div>
        </div>
      </div>
    </div>
  `;
}
</script>
</body>
</html>
