<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="refresh" content="15">
<title>Mission Control</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #0d1117;
  color: #e6edf3;
  min-height: 100vh;
  padding: 20px;
}

/* Modal */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 20px;
}
.modal-overlay.active { display: flex; }
.modal {
  background: #161b22;
  border: 1px solid #30363d;
  border-radius: 16px;
  max-width: 500px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  animation: slideUp 0.2s ease;
}
@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.modal-header {
  padding: 20px;
  border-bottom: 1px solid #30363d;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}
.modal-title {
  font-size: 18px;
  font-weight: 600;
  color: #e6edf3;
}
.modal-id {
  font-size: 12px;
  color: #8b949e;
  font-family: monospace;
  margin-top: 4px;
}
.modal-close {
  background: none;
  border: none;
  color: #8b949e;
  font-size: 24px;
  cursor: pointer;
  padding: 0 8px;
}
.modal-close:hover { color: #e6edf3; }
.modal-body { padding: 20px; }
.modal-section {
  margin-bottom: 16px;
}
.modal-section:last-child { margin-bottom: 0; }
.modal-label {
  font-size: 11px;
  text-transform: uppercase;
  color: #8b949e;
  margin-bottom: 6px;
  font-weight: 600;
}
.modal-content {
  font-size: 14px;
  color: #e6edf3;
  line-height: 1.5;
  background: #0d1117;
  padding: 12px;
  border-radius: 8px;
}
.modal-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  color: #58a6ff;
  text-decoration: none;
  background: rgba(88,166,255,0.1);
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 13px;
}
.modal-link:hover { background: rgba(88,166,255,0.2); }
.modal-status {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}
.modal-status.done { background: rgba(63,185,80,0.15); color: #3fb950; }
.modal-status.pending { background: rgba(139,148,158,0.15); color: #8b949e; }
.modal-status.in-progress { background: rgba(63,185,80,0.25); color: #3fb950; }
.container { max-width: 1200px; margin: 0 auto; }

/* Header */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #21262d;
}
.header h1 {
  font-size: 24px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.status-badge {
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
}
.status-badge.working { background: rgba(52,211,153,0.15); color: #34d399; }
.status-badge.idle { background: rgba(139,148,158,0.15); color: #8b949e; }
.live-dot {
  width: 10px;
  height: 10px;
  background: #3fb950;
  border-radius: 50%;
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

/* Deadline Banner */
.deadline-banner {
  background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
  border-radius: 12px;
  padding: 16px 20px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.deadline-text { font-size: 16px; font-weight: 600; }
.deadline-days { font-size: 28px; font-weight: 700; }

/* Task Board Grid */
.task-board {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

/* Lane Cards */
.lane {
  background: #161b22;
  border: 1px solid #30363d;
  border-radius: 12px;
  padding: 16px;
  min-height: 200px;
}
.lane-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid #21262d;
}
.lane-title {
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}
.lane-count {
  background: #21262d;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 12px;
  color: #8b949e;
}

/* Bot Current - Special styling */
.lane.bot-current {
  border-color: #238636;
  background: linear-gradient(135deg, #161b22 0%, #0d1a0f 100%);
}
.lane.bot-current .lane-title { color: #3fb950; }

/* Human Lane - Special styling */
.lane.human {
  border-color: #1f6feb;
  background: linear-gradient(135deg, #161b22 0%, #0d1117 100%);
}
.lane.human .lane-title { color: #58a6ff; }

/* Task Items */
.task-item {
  background: #0d1117;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  border-left: 3px solid #30363d;
  cursor: pointer;
  transition: all 0.2s;
}
.task-item:hover {
  background: #1c2128;
  transform: translateX(4px);
}
.task-item.in-progress {
  border-left-color: #3fb950;
  background: rgba(63,185,80,0.05);
}
.task-item.pending { border-left-color: #8b949e; }
.task-item.human-task { border-left-color: #58a6ff; }

.task-id {
  font-size: 11px;
  color: #8b949e;
  margin-bottom: 4px;
  font-family: monospace;
}
.task-title-text {
  font-size: 14px;
  color: #e6edf3;
  margin-bottom: 6px;
  font-weight: 500;
}
.task-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.task-plan {
  font-size: 11px;
  color: #58a6ff;
  text-decoration: none;
  background: rgba(88,166,255,0.1);
  padding: 2px 6px;
  border-radius: 4px;
}
.task-plan:hover { background: rgba(88,166,255,0.2); }
.task-estimate {
  font-size: 11px;
  color: #8b949e;
  background: #21262d;
  padding: 2px 6px;
  border-radius: 4px;
}

/* Done Section */
.done-section {
  background: #161b22;
  border: 1px solid #30363d;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 24px;
}
.done-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  padding-bottom: 12px;
}
.done-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 8px;
}
.done-grid.collapsed { display: none; }
.done-item {
  background: #0d1117;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 13px;
  color: #8b949e;
  display: flex;
  align-items: center;
  gap: 8px;
}
.done-item .check { color: #3fb950; }
.done-item:hover { background: #1c2128; }

/* Scheduled Section */
.scheduled-section {
  background: #161b22;
  border: 1px solid #30363d;
  border-radius: 12px;
  padding: 16px;
}
.scheduled-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 8px;
}
.scheduled-item {
  background: #0d1117;
  padding: 10px;
  border-radius: 6px;
  font-size: 12px;
}
.scheduled-title { color: #e6edf3; margin-bottom: 4px; }
.scheduled-time { color: #8b949e; font-size: 11px; }

/* Footer */
.footer {
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid #21262d;
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  color: #484f58;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .task-board { grid-template-columns: 1fr; }
  .deadline-banner { flex-direction: column; gap: 8px; text-align: center; }
}
</style>
</head>
<body>
<!-- Task Detail Modal -->
<div class="modal-overlay" id="taskModal" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="modalTitle">Task Title</div>
        <div class="modal-id" id="modalId">T001</div>
      </div>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="modal-section">
        <div class="modal-label">Status</div>
        <span class="modal-status" id="modalStatus">pending</span>
      </div>
      <div class="modal-section" id="modalContextSection">
        <div class="modal-label">üí° Context / Why This Exists</div>
        <div class="modal-content" id="modalContext"></div>
      </div>
      <div class="modal-section" id="modalStepsSection">
        <div class="modal-label">üìã Steps Progress</div>
        <div class="modal-content" id="modalSteps"></div>
      </div>
      <div class="modal-section" id="modalApproachSection">
        <div class="modal-label">üéØ Approach / How</div>
        <div class="modal-content" id="modalApproach"></div>
      </div>
      <div class="modal-section" id="modalNotesSection">
        <div class="modal-label">üìù Notes</div>
        <div class="modal-content" id="modalNotes"></div>
      </div>
      <div class="modal-section" id="modalPlanSection">
        <div class="modal-label">üìÑ Plan Document</div>
        <a class="modal-link" id="modalPlanLink" href="#" target="_blank">
          <span>üìÑ</span> <span id="modalPlanName">plan.md</span>
        </a>
      </div>
      <div class="modal-section" id="modalTimelineSection">
        <div class="modal-label">üìÖ Timeline</div>
        <div class="modal-content" id="modalTimeline"></div>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="header">
    <h1><span class="live-dot"></span> Mission Control</h1>
    <div class="status-badge working" id="globalStatus">WORKING</div>
  </div>

  <div class="deadline-banner">
    <span class="deadline-text">üíï Valentine's Day Order Cutoff</span>
    <span class="deadline-days" id="deadlineDays">-- days</span>
  </div>

  <div class="task-board" id="taskBoard">
    <!-- Bot Current -->
    <div class="lane bot-current">
      <div class="lane-header">
        <span class="lane-title">ü§ñ Bot ‚Äî Working Now</span>
        <span class="lane-count" id="botCurrentCount">0</span>
      </div>
      <div id="botCurrentTasks">Loading...</div>
    </div>

    <!-- Bot Queue -->
    <div class="lane">
      <div class="lane-header">
        <span class="lane-title">üìã Bot ‚Äî Queue</span>
        <span class="lane-count" id="botQueueCount">0</span>
      </div>
      <div id="botQueueTasks">Loading...</div>
    </div>

    <!-- Human Tasks -->
    <div class="lane human">
      <div class="lane-header">
        <span class="lane-title">üë§ Francisco ‚Äî Your Tasks</span>
        <span class="lane-count" id="humanCount">0</span>
      </div>
      <div id="humanTasks">Loading...</div>
    </div>
  </div>

  <!-- Done Today -->
  <div class="done-section">
    <div class="done-header" onclick="toggleDone()">
      <span class="lane-title">‚úÖ Done Today <span class="lane-count" id="doneCount">0</span></span>
      <span id="doneToggle">‚ñº Show</span>
    </div>
    <div class="done-grid collapsed" id="doneTasks"></div>
  </div>

  <!-- Scheduled -->
  <div class="scheduled-section">
    <div class="lane-header">
      <span class="lane-title">‚è∞ Scheduled (Cron Jobs)</span>
    </div>
    <div class="scheduled-grid" id="scheduledTasks">Loading...</div>
  </div>

  <div class="footer">
    <span>Auto-refreshes every 15 seconds</span>
    <span id="lastUpdate"></span>
  </div>
</div>

<script>
let allTasks = {};  // Store tasks globally for modal access

async function loadTaskBoard() {
  try {
    const resp = await fetch('/api/tasks?' + Date.now());
    const data = await resp.json();
    
    const tasks = data.tasks || {};
    allTasks = tasks;  // Store for modal
    const lanes = data.lanes || {};
    
    // Calculate deadline
    const deadline = new Date('2026-02-10');
    const today = new Date();
    const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
    document.getElementById('deadlineDays').textContent = daysLeft + ' days';
    
    // Render Bot Current
    const botCurrentIds = lanes.bot_current || [];
    document.getElementById('botCurrentCount').textContent = botCurrentIds.length;
    document.getElementById('botCurrentTasks').innerHTML = botCurrentIds.map(id => {
      const t = tasks[id];
      if (!t) return '';
      return renderTask(id, t, 'in-progress');
    }).join('') || '<div style="color:#8b949e;font-size:13px;">No active task</div>';
    
    // Render Bot Queue
    const botQueueIds = lanes.bot_queue || [];
    document.getElementById('botQueueCount').textContent = botQueueIds.length;
    document.getElementById('botQueueTasks').innerHTML = botQueueIds.map((id, idx) => {
      const t = tasks[id];
      if (!t) return '';
      return renderTask(id, t, 'pending', idx === 0 ? 'NEXT' : null);
    }).join('') || '<div style="color:#8b949e;font-size:13px;">Queue empty üéâ</div>';
    
    // Render Human Tasks
    const humanIds = lanes.human || [];
    document.getElementById('humanCount').textContent = humanIds.length;
    document.getElementById('humanTasks').innerHTML = humanIds.map(id => {
      const t = tasks[id];
      if (!t) return '';
      return renderTask(id, t, 'human-task');
    }).join('') || '<div style="color:#8b949e;font-size:13px;">All done! üéâ</div>';
    
    // Render Done Today
    const doneIds = lanes.done_today || [];
    document.getElementById('doneCount').textContent = doneIds.length;
    document.getElementById('doneTasks').innerHTML = doneIds.map(id => {
      const t = tasks[id];
      if (!t) return '';
      return `<div class="done-item" onclick="showTaskDetail('${id}')" style="cursor:pointer;"><span class="check">‚úì</span>${t.title}</div>`;
    }).join('') || '<div class="done-item">Nothing yet</div>';
    
    // Render Scheduled
    const schedIds = lanes.scheduled || [];
    document.getElementById('scheduledTasks').innerHTML = schedIds.map(id => {
      const t = tasks[id];
      if (!t) return '';
      return `
        <div class="scheduled-item">
          <div class="scheduled-title">${t.title}</div>
          <div class="scheduled-time">${t.schedule || ''}</div>
        </div>
      `;
    }).join('') || '<div style="color:#8b949e;">No scheduled tasks</div>';
    
    document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();
    
  } catch(e) {
    console.error('Failed to load tasks:', e);
    document.getElementById('botCurrentTasks').innerHTML = '<div style="color:#f85149;">Failed to load tasks.json</div>';
  }
}

function renderTask(id, task, statusClass, badge) {
  const planLink = task.plan ? `<span class="task-plan">üìÑ ${task.plan.split('/').pop()}</span>` : '';
  const estimate = task.estimate ? `<span class="task-estimate">‚è± ${task.estimate}</span>` : '';
  const badgeHtml = badge ? `<span class="task-estimate" style="background:#238636;color:#fff;">${badge}</span>` : '';
  
  // Step progress indicator
  let stepProgress = '';
  if (task.steps && task.steps.length > 0) {
    const currentStep = task.current_step || 0;
    const doneSteps = task.steps.filter(s => s.status === 'done').length;
    const totalSteps = task.steps.length;
    const currentStepInfo = task.steps[currentStep];
    const stepStatus = currentStepInfo ? currentStepInfo.status : 'pending';
    
    let stepIcon = 'üìã';
    let stepColor = '#8b949e';
    if (stepStatus === 'waiting') {
      stepIcon = '‚è≥';
      stepColor = '#d29922';
    } else if (stepStatus === 'in_progress') {
      stepIcon = '‚ö°';
      stepColor = '#f0883e';
    } else if (stepStatus === 'blocked') {
      stepIcon = 'üö´';
      stepColor = '#f85149';
    }
    
    stepProgress = `<span class="task-estimate" style="background:rgba(88,166,255,0.15);color:${stepColor};">${stepIcon} Step ${currentStep + 1}/${totalSteps}</span>`;
  }
  
  return `
    <div class="task-item ${statusClass}" onclick="showTaskDetail('${id}')">
      <div class="task-id">${id}</div>
      <div class="task-title-text">${task.title}</div>
      <div class="task-meta">
        ${stepProgress}
        ${planLink}
        ${estimate}
        ${badgeHtml}
      </div>
    </div>
  `;
}

function showTaskDetail(id) {
  const task = allTasks[id];
  if (!task) return;
  
  document.getElementById('modalTitle').textContent = task.title;
  document.getElementById('modalId').textContent = id;
  
  // Status
  const statusEl = document.getElementById('modalStatus');
  const status = task.status || 'pending';
  statusEl.textContent = status;
  statusEl.className = 'modal-status ' + (status === 'done' ? 'done' : status === 'in_progress' ? 'in-progress' : 'pending');
  
  // Context (the WHY)
  const contextSection = document.getElementById('modalContextSection');
  if (task.context && task.context.summary) {
    let contextHtml = task.context.summary;
    // Add decisions if present
    if (task.context.decisions && task.context.decisions.length > 0) {
      contextHtml += '<div style="margin-top:12px;font-size:12px;"><strong>Key Decisions:</strong><ul style="margin:4px 0 0 16px;">';
      task.context.decisions.forEach(d => {
        contextHtml += '<li>' + d + '</li>';
      });
      contextHtml += '</ul></div>';
    }
    // Add constraints if present
    if (task.context.constraints && task.context.constraints.length > 0) {
      contextHtml += '<div style="margin-top:8px;font-size:12px;"><strong>Constraints:</strong><ul style="margin:4px 0 0 16px;">';
      task.context.constraints.forEach(c => {
        contextHtml += '<li>' + c + '</li>';
      });
      contextHtml += '</ul></div>';
    }
    document.getElementById('modalContext').innerHTML = contextHtml;
    contextSection.style.display = 'block';
  } else {
    contextSection.style.display = 'none';
  }
  
  // Steps Progress
  const stepsSection = document.getElementById('modalStepsSection');
  if (task.steps && task.steps.length > 0) {
    const currentStep = task.current_step || 0;
    let stepsHtml = '<div style="display:flex;flex-direction:column;gap:8px;">';
    task.steps.forEach((step, idx) => {
      let icon, color, bgColor;
      switch(step.status) {
        case 'done':
          icon = '‚úÖ'; color = '#3fb950'; bgColor = 'rgba(63,185,80,0.1)';
          break;
        case 'in_progress':
          icon = '‚ö°'; color = '#f0883e'; bgColor = 'rgba(240,136,62,0.1)';
          break;
        case 'waiting':
          icon = '‚è≥'; color = '#d29922'; bgColor = 'rgba(210,153,34,0.1)';
          break;
        case 'blocked':
          icon = 'üö´'; color = '#f85149'; bgColor = 'rgba(248,81,73,0.1)';
          break;
        default:
          icon = '‚¨ú'; color = '#8b949e'; bgColor = 'transparent';
      }
      const isCurrent = idx === currentStep && step.status !== 'done';
      const border = isCurrent ? 'border: 1px solid ' + color + ';' : '';
      let stepInfo = step.step;
      if (step.waiting_for) {
        stepInfo += '<div style="font-size:11px;color:#d29922;margin-top:4px;">‚è≥ Waiting for: ' + step.waiting_for + '</div>';
      }
      if (step.completed_at) {
        const completedTime = new Date(step.completed_at).toLocaleString();
        stepInfo += '<div style="font-size:10px;color:#8b949e;margin-top:2px;">‚úì ' + completedTime + '</div>';
      }
      stepsHtml += `
        <div style="display:flex;gap:10px;padding:8px;border-radius:6px;background:${bgColor};${border}">
          <span style="font-size:16px;">${icon}</span>
          <div style="flex:1;">
            <div style="color:${step.status === 'done' ? '#8b949e' : '#e6edf3'};${step.status === 'done' ? 'text-decoration:line-through;' : ''}">${stepInfo}</div>
          </div>
          <span style="font-size:11px;color:#8b949e;">${idx + 1}/${task.steps.length}</span>
        </div>
      `;
    });
    stepsHtml += '</div>';
    // Add retry count if exists
    if (task.retry_count && task.retry_count > 0) {
      stepsHtml += `<div style="margin-top:8px;font-size:11px;color:#f85149;">‚ö†Ô∏è Retry count: ${task.retry_count}/3</div>`;
    }
    document.getElementById('modalSteps').innerHTML = stepsHtml;
    stepsSection.style.display = 'block';
  } else {
    stepsSection.style.display = 'none';
  }
  
  // Approach
  const approachSection = document.getElementById('modalApproachSection');
  if (task.approach) {
    document.getElementById('modalApproach').textContent = task.approach;
    approachSection.style.display = 'block';
  } else {
    approachSection.style.display = 'none';
  }
  
  // Notes
  const notesSection = document.getElementById('modalNotesSection');
  if (task.notes) {
    document.getElementById('modalNotes').textContent = task.notes;
    notesSection.style.display = 'block';
  } else {
    notesSection.style.display = 'none';
  }
  
  // Plan link
  const planSection = document.getElementById('modalPlanSection');
  if (task.plan) {
    document.getElementById('modalPlanLink').href = '../' + task.plan;
    document.getElementById('modalPlanName').textContent = task.plan;
    planSection.style.display = 'block';
  } else {
    planSection.style.display = 'none';
  }
  
  // Timeline (created + completed)
  const timelineSection = document.getElementById('modalTimelineSection');
  let timelineHtml = '';
  if (task.created) {
    const createdDate = new Date(task.created).toLocaleString();
    timelineHtml += `<div style="margin-bottom:8px;">üìù <strong>Created:</strong> ${createdDate}</div>`;
    timelineHtml += `<div style="font-size:11px;color:#8b949e;margin-bottom:8px;">‚Üë Find this time in Telegram to see original conversation</div>`;
  }
  if (task.completed) {
    const completedDate = new Date(task.completed).toLocaleString();
    timelineHtml += `<div>‚úÖ <strong>Completed:</strong> ${completedDate}</div>`;
    // Calculate duration if both exist
    if (task.created) {
      const duration = new Date(task.completed) - new Date(task.created);
      const hours = Math.floor(duration / (1000 * 60 * 60));
      const mins = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
      if (hours > 0 || mins > 0) {
        timelineHtml += `<div style="margin-top:8px;color:#8b949e;">‚è± Duration: ${hours > 0 ? hours + 'h ' : ''}${mins}m</div>`;
      }
    }
  }
  if (timelineHtml) {
    document.getElementById('modalTimeline').innerHTML = timelineHtml;
    timelineSection.style.display = 'block';
  } else {
    timelineSection.style.display = 'none';
  }
  
  document.getElementById('taskModal').classList.add('active');
}

function closeModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('taskModal').classList.remove('active');
}

function toggleDone() {
  const grid = document.getElementById('doneTasks');
  const toggle = document.getElementById('doneToggle');
  if (grid.classList.contains('collapsed')) {
    grid.classList.remove('collapsed');
    toggle.textContent = '‚ñ≤ Hide';
  } else {
    grid.classList.add('collapsed');
    toggle.textContent = '‚ñº Show';
  }
}

loadTaskBoard();

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});
</script>
</body>
</html>
