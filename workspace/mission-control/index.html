<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Auto-refresh handled by JavaScript to preserve modal state -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<title>Mission Control</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(145deg, #0a0a0f 0%, #0f0f18 50%, #0a0a0f 100%);
  color: #c9d1d9;
  min-height: 100vh;
  padding: 20px;
  line-height: 1.6;
  font-size: 14px;
  letter-spacing: -0.01em;
}
.container { max-width: 1280px; margin: 0 auto; }

/* Modal */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(4px);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 20px;
}
.modal-overlay.active { display: flex; }
.modal {
  background: rgba(22, 27, 34, 0.98);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px;
  max-width: 500px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1);
  backdrop-filter: blur(20px);
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}
@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.modal-header {
  padding: 18px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}
.modal-title {
  font-size: 16px;
  font-weight: 600;
  color: #e6edf3;
  letter-spacing: -0.01em;
}
.modal-id {
  font-size: 14px;
  color: #60a5fa;
  font-family: 'SF Mono', 'Fira Code', monospace;
  margin-top: 4px;
  font-weight: 700;
}
.modal-close {
  background: none;
  border: none;
  color: #6e7681;
  font-size: 22px;
  cursor: pointer;
  padding: 0 8px;
  transition: color 0.15s;
}
.modal-close:hover { color: #c9d1d9; }
.modal-body { padding: 18px 20px; }
.modal-section {
  margin-bottom: 14px;
}
.modal-section:last-child { margin-bottom: 0; }
.modal-label {
  font-size: 10px;
  text-transform: uppercase;
  color: #6e7681;
  margin-bottom: 6px;
  font-weight: 600;
  letter-spacing: 0.05em;
}
.modal-content {
  font-size: 13px;
  color: #c9d1d9;
  line-height: 1.55;
  background: rgba(0,0,0,0.2);
  padding: 12px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.04);
}
.modal-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  color: #58a6ff;
  text-decoration: none;
  background: rgba(88,166,255,0.1);
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 13px;
}
.modal-link:hover { background: rgba(88,166,255,0.2); }
.modal-status {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}
.modal-status.done { background: rgba(63,185,80,0.15); color: #3fb950; }
.modal-status.pending { background: rgba(139,148,158,0.15); color: #8b949e; }
.modal-status.in-progress { background: rgba(63,185,80,0.25); color: #3fb950; }
.container { max-width: 1200px; margin: 0 auto; }

/* Header */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  padding-bottom: 14px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}
.header h1 {
  font-size: 18px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 10px;
  color: #e6edf3;
  letter-spacing: -0.02em;
}
.status-badge {
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.status-badge.working { 
  background: rgba(74, 222, 128, 0.1); 
  color: #4ade80;
  box-shadow: 0 0 20px rgba(74, 222, 128, 0.08);
}
.status-badge.idle { 
  background: rgba(148,163,184,0.08); 
  color: #94a3b8;
}
.live-dot {
  width: 8px;
  height: 8px;
  background: #4ade80;
  border-radius: 50%;
  animation: gentlePulse 3s ease-in-out infinite;
  box-shadow: 0 0 8px rgba(74, 222, 128, 0.4);
}
@keyframes gentlePulse { 0%,100% { opacity:1; transform: scale(1); } 50% { opacity:0.6; transform: scale(0.9); } }

/* Deadline Banner - Elegant Pink */
.deadline-banner {
  background: linear-gradient(135deg, rgba(236, 72, 153, 0.06) 0%, rgba(168, 85, 247, 0.04) 100%);
  border: 1px solid rgba(236, 72, 153, 0.15);
  border-radius: 12px;
  padding: 16px 22px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.deadline-text {
  font-size: 14px;
  font-weight: 500;
  color: #f9a8d4;
  letter-spacing: -0.01em;
}
.deadline-days {
  font-size: 22px;
  font-weight: 600;
  color: #f472b6;
  letter-spacing: -0.02em;
}

/* Task Board Grid */
.task-board {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 14px;
  margin-bottom: 20px;
}

/* Lane Cards - Refined */
.lane {
  background: rgba(13, 17, 23, 0.7);
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: 14px;
  padding: 16px;
  min-height: 180px;
  backdrop-filter: blur(10px);
  transition: border-color 0.2s ease;
}
.lane:hover {
  border-color: rgba(255,255,255,0.08);
}
.lane-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}
.lane-title {
  font-size: 12px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}
.lane-count {
  background: rgba(96,165,250,0.2);
  padding: 3px 10px;
  border-radius: 10px;
  font-size: 14px;
  color: #60a5fa;
  font-weight: 700;
}

/* Bot Current - Soft Green */
.lane.bot-current {
  border-color: rgba(74, 222, 128, 0.2);
  border-left: 2px solid rgba(74, 222, 128, 0.6);
  background: linear-gradient(135deg, rgba(74, 222, 128, 0.03) 0%, rgba(13, 17, 23, 0.7) 100%);
}
.lane.bot-current .lane-title {
  color: #86efac;
}
/* Bot Queue - Soft Amber */
.lane.bot-queue {
  border-color: rgba(251, 191, 36, 0.15);
  border-left: 2px solid rgba(251, 191, 36, 0.5);
  background: linear-gradient(135deg, rgba(251, 191, 36, 0.02) 0%, rgba(13, 17, 23, 0.7) 100%);
}
.lane.bot-queue .lane-title {
  color: #fcd34d;
}

/* Human Lane - Soft Blue */
.lane.human {
  border-color: rgba(96, 165, 250, 0.15);
  border-left: 2px solid rgba(96, 165, 250, 0.5);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.02) 0%, rgba(13, 17, 23, 0.7) 100%);
}
.lane.human .lane-title {
  color: #93c5fd;
}

/* Task Items - Refined Cards */
.task-item {
  background: rgba(22, 27, 34, 0.6);
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 8px;
  border: 1px solid rgba(255,255,255,0.03);
  cursor: pointer;
  transition: all 0.2s ease;
}
.task-item:hover {
  background: rgba(30, 35, 44, 0.8);
  border-color: rgba(255,255,255,0.08);
  transform: translateY(-1px);
}
.task-item.in-progress {
  border-left: 2px solid rgba(74, 222, 128, 0.7);
  background: linear-gradient(90deg, rgba(74, 222, 128, 0.04) 0%, rgba(22, 27, 34, 0.6) 100%);
}
.task-item.pending { border-color: rgba(255,255,255,0.05); }
.task-item.human-task { 
  border-color: rgba(96, 165, 250, 0.1);
  border-left: 2px solid rgba(96, 165, 250, 0.4);
}

.task-id {
  font-size: 13px;
  color: #60a5fa;
  margin-bottom: 4px;
  font-family: 'SF Mono', 'Fira Code', monospace;
  letter-spacing: 0.02em;
  font-weight: 700;
}
.task-title-text {
  font-size: 13px;
  color: #e6edf3;
  margin-bottom: 8px;
  font-weight: 500;
  line-height: 1.4;
  letter-spacing: -0.01em;
}
.task-meta {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}
/* Progress bar for multi-step tasks */
.task-progress {
  width: 100%;
  height: 2px;
  background: rgba(255,255,255,0.06);
  border-radius: 2px;
  margin: 8px 0 4px;
  overflow: hidden;
}
.task-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #4ade80 0%, #86efac 100%);
  border-radius: 2px;
  transition: width 0.3s ease;
}
.task-step-text {
  font-size: 11px;
  color: #86efac;
  font-weight: 600;
}
.task-toolbar {
  display: flex;
  align-items: center;
  gap: 3px;
  margin-left: auto;
  background: rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: 6px;
  padding: 3px 5px;
}
.task-plan {
  font-size: 10px;
  color: #58a6ff;
  text-decoration: none;
  background: rgba(88,166,255,0.08);
  padding: 2px 6px;
  border-radius: 4px;
  transition: all 0.15s;
}
.task-plan:hover { background: rgba(88,166,255,0.15); }
.task-estimate {
  font-size: 10px;
  color: #8b949e;
  background: rgba(255,255,255,0.05);
  padding: 2px 6px;
  border-radius: 4px;
}
.complete-btn {
  font-size: 10px;
  color: #3fb950;
  background: rgba(63,185,80,0.1);
  border: 1px solid rgba(63,185,80,0.2);
  padding: 3px 7px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
  font-weight: 500;
}
.complete-btn:hover {
  background: rgba(63,185,80,0.2);
  border-color: rgba(63,185,80,0.4);
}
.complete-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.complete-btn.pending {
  color: #d4a574;
  background: rgba(212,165,116,0.1);
  border-color: rgba(212,165,116,0.2);
}
.reorder-btn {
  font-size: 10px;
  color: #6e7681;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.06);
  padding: 3px 5px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s;
}
.reorder-btn:hover {
  color: #58a6ff;
  background: rgba(88,166,255,0.1);
  border-color: rgba(88,166,255,0.2);
}
.reorder-btn:disabled {
  opacity: 0.25;
  cursor: not-allowed;
}
.reorder-controls {
  display: flex;
  gap: 2px;
}
.delete-btn {
  font-size: 12px;
  font-weight: 500;
  color: #f87171;
  background: rgba(248,113,113,0.08);
  border: 1px solid rgba(248,113,113,0.15);
  padding: 3px 6px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s;
}
.delete-btn:hover {
  background: rgba(248,113,113,0.15);
  border-color: rgba(248,113,113,0.3);
}
.transfer-btn {
  font-size: 10px;
  color: #58a6ff;
  background: rgba(88,166,255,0.08);
  border: 1px solid rgba(88,166,255,0.15);
  padding: 3px 7px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s;
  font-weight: 500;
}
.transfer-btn:hover {
  background: rgba(88,166,255,0.15);
  border-color: rgba(88,166,255,0.3);
}
.pause-btn {
  color: #fb923c;
  border: 1px solid rgba(251,146,60,0.2);
  background: rgba(251,146,60,0.08);
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
  letter-spacing: 1px;
}
.pause-btn:hover {
  background: rgba(251,146,60,0.15);
  border-color: rgba(251,146,60,0.3);
}
.confirm-bubble {
  display: none;
  position: fixed;
  background: rgba(22, 27, 34, 0.98);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 14px;
  text-align: center;
  width: 200px;
  z-index: 2000;
  box-shadow: 0 12px 40px rgba(0,0,0,0.5);
  animation: fadeIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
  backdrop-filter: blur(16px);
}
.confirm-bubble.active { display: block; }
.confirm-bubble::before {
  content: '';
  position: absolute;
  top: -7px;
  right: 20px;
  border-left: 7px solid transparent;
  border-right: 7px solid transparent;
  border-bottom: 7px solid rgba(255,255,255,0.1);
}
.confirm-bubble::after {
  content: '';
  position: absolute;
  top: -5px;
  right: 21px;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-bottom: 6px solid rgba(22, 27, 34, 0.98);
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-8px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.confirm-bubble .confirm-title {
  font-size: 12px;
  font-weight: 600;
  color: #e6edf3;
  margin-bottom: 6px;
}
.confirm-bubble .confirm-message {
  font-size: 11px;
  color: #8b949e;
  margin-bottom: 12px;
  line-height: 1.4;
}
.confirm-buttons {
  display: flex;
  gap: 6px;
  justify-content: center;
}
.confirm-btn {
  padding: 6px 14px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
}
.confirm-btn.cancel {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  color: #c9d1d9;
}
.confirm-btn.cancel:hover {
  background: rgba(255,255,255,0.1);
}
.confirm-btn.delete {
  background: rgba(248,113,113,0.15);
  border: 1px solid rgba(248,113,113,0.3);
  color: #f87171;
}
.confirm-btn.delete:hover {
  background: rgba(248,113,113,0.25);
}

/* Done Section */
/* Predictions Section */
.predictions-section {
  background: rgba(13, 17, 23, 0.5);
  border: 1px solid rgba(139,92,246,0.15);
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 16px;
}
.predictions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 10px;
  margin-top: 12px;
}
.predictions-grid.collapsed { display: none; }
.prediction-card {
  background: rgba(22, 27, 34, 0.6);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 10px;
  padding: 12px;
}
.prediction-card.scored-correct {
  border-color: rgba(63,185,80,0.4);
  background: rgba(63,185,80,0.05);
}
.prediction-card.scored-wrong {
  border-color: rgba(248,113,113,0.4);
  background: rgba(248,113,113,0.05);
}
.prediction-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}
.prediction-id {
  font-size: 10px;
  color: #8b949e;
  background: rgba(139,92,246,0.15);
  padding: 2px 6px;
  border-radius: 4px;
}
.prediction-confidence {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
}
.prediction-confidence.HIGH { background: rgba(63,185,80,0.2); color: #3fb950; }
.prediction-confidence.MEDIUM { background: rgba(251,191,36,0.2); color: #fbbf24; }
.prediction-confidence.LOW { background: rgba(248,113,113,0.2); color: #f87171; }
.prediction-text {
  font-size: 13px;
  color: #e6edf3;
  margin-bottom: 6px;
  line-height: 1.4;
}
.prediction-rationale {
  font-size: 11px;
  color: #8b949e;
  margin-bottom: 10px;
}
.prediction-actions {
  display: flex;
  gap: 8px;
}
.score-btn {
  flex: 1;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
}
.score-btn.correct {
  background: rgba(63,185,80,0.15);
  border: 1px solid rgba(63,185,80,0.3);
  color: #3fb950;
}
.score-btn.correct:hover { background: rgba(63,185,80,0.25); }
.score-btn.correct.active { background: rgba(63,185,80,0.4); }
.score-btn.wrong {
  background: rgba(248,113,113,0.15);
  border: 1px solid rgba(248,113,113,0.3);
  color: #f87171;
}
.score-btn.wrong:hover { background: rgba(248,113,113,0.25); }
.score-btn.wrong.active { background: rgba(248,113,113,0.4); }
.predictions-history.collapsed { display: none; }
.game-stats.collapsed { display: none; }
.history-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  margin-bottom: 6px;
  font-size: 12px;
}
.history-item .date { color: #6e7681; min-width: 80px; }
.history-item .pred-id { color: #a78bfa; font-weight: 600; min-width: 30px; }
.history-item .score-correct { color: #3fb950; }
.history-item .score-wrong { color: #f87171; }
.history-item .note { color: #8b949e; flex: 1; }

.done-section {
  background: rgba(13, 17, 23, 0.5);
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 16px;
}
.done-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-bottom: 10px;
  flex-wrap: wrap;
  gap: 10px;
}
.done-header-left {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}
.done-date-filter {
  display: flex;
  align-items: center;
  gap: 4px;
}
.date-btn {
  font-size: 10px;
  color: #8b949e;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.06);
  padding: 4px 10px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}
.date-btn:hover {
  background: rgba(255,255,255,0.08);
  color: #c9d1d9;
}
.date-btn.active {
  background: rgba(63, 185, 80, 0.15);
  border-color: rgba(63, 185, 80, 0.3);
  color: #3fb950;
}
.date-input {
  font-size: 10px;
  color: #c9d1d9;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.06);
  padding: 4px 8px;
  border-radius: 6px;
  cursor: pointer;
}
.date-input::-webkit-calendar-picker-indicator {
  filter: invert(0.7);
}
.done-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 6px;
}
.done-grid.collapsed { display: none; }
.done-item {
  background: rgba(255,255,255,0.02);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  color: #8b949e;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.15s ease;
}
.done-item .check { color: #3fb950; font-size: 11px; }
.done-item:hover { background: rgba(255,255,255,0.05); color: #c9d1d9; }

/* Scheduled Section */
.scheduled-section {
  background: rgba(13, 17, 23, 0.5);
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: 14px;
  padding: 14px;
}
.scheduled-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
  gap: 6px;
}
.scheduled-item {
  background: rgba(255,255,255,0.02);
  padding: 10px 12px;
  border-radius: 10px;
  font-size: 12px;
  transition: all 0.2s;
  border: 1px solid transparent;
  display: flex;
  align-items: center;
  gap: 8px;
}
.scheduled-item:hover {
  background: rgba(255,255,255,0.05);
  border-color: rgba(255,255,255,0.06);
}
.scheduled-content {
  flex: 1;
  cursor: pointer;
}
.scheduled-title { color: #c9d1d9; margin-bottom: 3px; font-weight: 500; font-size: 12px; }
.scheduled-time { color: #d4a574; font-size: 10px; margin-bottom: 2px; }
.scheduled-next { color: #6e7681; font-size: 10px; }
.scheduled-delete {
  padding: 3px 5px;
  font-size: 11px;
  opacity: 0.6;
  transition: opacity 0.15s;
}
.scheduled-item:hover .scheduled-delete {
  opacity: 1;
}
.trash-section {
  background: rgba(13, 17, 23, 0.5);
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 14px;
}
.trash-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 6px;
}
.trash-item {
  background: rgba(255,255,255,0.02);
  padding: 8px 12px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 12px;
  color: #6e7681;
  border: 1px solid transparent;
  transition: all 0.15s;
}
.trash-item:hover {
  border-color: rgba(255,255,255,0.06);
  background: rgba(255,255,255,0.04);
}
.trash-item-title {
  flex: 1;
  text-decoration: line-through;
}
.trash-item-date {
  font-size: 9px;
  color: #484f58;
}
.restore-btn {
  font-size: 10px;
  color: #3fb950;
  background: rgba(63,185,80,0.08);
  border: 1px solid rgba(63,185,80,0.15);
  padding: 3px 7px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s;
  font-weight: 500;
}
.restore-btn:hover {
  background: rgba(63,185,80,0.15);
}
.perma-delete-btn {
  font-size: 11px;
  color: #f87171;
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px;
  transition: color 0.15s;
}
.perma-delete-btn:hover {
  color: #fca5a5;
}
.cron-input {
  width: 100%;
  background: rgba(0,0,0,0.25);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 8px;
  padding: 10px 12px;
  color: #c9d1d9;
  font-size: 13px;
  margin-top: 6px;
  transition: all 0.15s;
}
.cron-input:focus {
  outline: none;
  border-color: rgba(88,166,255,0.4);
  background: rgba(0,0,0,0.3);
}

/* Footer */
.footer {
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px solid rgba(255,255,255,0.04);
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: #484f58;
}

/* Mobile responsive */
@media (max-width: 768px) {
  body { padding: 12px; }
  .task-board { grid-template-columns: 1fr; }
  .deadline-banner { flex-direction: column; gap: 6px; text-align: center; padding: 14px 16px; }
  .deadline-text { font-size: 13px; }
  .deadline-days { font-size: 20px; }
  .lane { padding: 14px; min-height: 150px; }
  .header h1 { font-size: 16px; }
}

/* Smooth scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }
</style>
</head>
<body>
<!-- Delete Confirm Bubble -->
<div class="confirm-bubble" id="confirmBubble">
  <div class="confirm-title" id="confirmTitle">Delete this task?</div>
  <div class="confirm-message" id="confirmMessage">Task name</div>
  <div class="confirm-buttons">
    <button class="confirm-btn cancel" onclick="cancelDelete()">Cancel</button>
    <button class="confirm-btn delete" onclick="confirmDelete()">Delete</button>
  </div>
</div>

<!-- Cron Detail Modal -->
<div class="modal-overlay" id="cronModal" onclick="closeCronModal(event)">
  <div class="modal" onclick="event.stopPropagation()" style="max-width:600px;">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="cronModalTitle">Cron Job</div>
        <div class="modal-id" id="cronModalId">CRON-xxx</div>
      </div>
      <button class="modal-close" onclick="closeCronModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="modal-section">
        <div class="modal-label">üí° What This Does</div>
        <div class="modal-content" id="cronSummary" style="font-size:14px;line-height:1.5;"></div>
      </div>
      <div class="modal-section">
        <div class="modal-label">‚è∞ Schedule</div>
        <input type="text" class="cron-input" id="cronSchedule" placeholder="e.g. 9 AM daily">
      </div>
      <div class="modal-section">
        <div class="modal-label">üìÖ Next Run</div>
        <input type="datetime-local" class="cron-input" id="cronNextRun">
      </div>
      <div class="modal-section">
        <div class="modal-label">üìÑ Plan/Procedure File</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
          <input type="text" class="cron-input" id="cronPlan" placeholder="path/to/procedure.md" style="flex:1;margin:0;">
          <button class="confirm-btn cancel" onclick="viewPlanFile()" style="white-space:nowrap;">üìñ View File</button>
        </div>
      </div>
      <div class="modal-section" id="planFileSection" style="display:none;">
        <div class="modal-label">üìã Plan File Contents</div>
        <div class="modal-content" id="planFileContent" style="max-height:300px;overflow-y:auto;font-size:12px;white-space:pre-wrap;font-family:monospace;"></div>
      </div>
      <div class="modal-section" style="margin-top: 20px;">
        <button class="confirm-btn delete" style="width:100%;" onclick="saveCronChanges()">üíæ Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Task Detail Modal -->
<div class="modal-overlay" id="taskModal" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="modalTitle">Task Title</div>
        <div class="modal-id" id="modalId">T001</div>
      </div>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="modal-section">
        <div class="modal-label">Status</div>
        <span class="modal-status" id="modalStatus">pending</span>
      </div>
      <div class="modal-section" id="modalContextSection">
        <div class="modal-label">üí° Context / Why This Exists</div>
        <div class="modal-content" id="modalContext"></div>
      </div>
      <div class="modal-section" id="modalStepsSection">
        <div class="modal-label">üìã Steps Progress</div>
        <div class="modal-content" id="modalSteps"></div>
      </div>
      <div class="modal-section" id="modalApproachSection">
        <div class="modal-label">üéØ Approach / How</div>
        <div class="modal-content" id="modalApproach"></div>
      </div>
      <div class="modal-section" id="modalNotesSection">
        <div class="modal-label">üìù Notes</div>
        <div class="modal-content" id="modalNotes"></div>
      </div>
      <div class="modal-section" id="modalLearningsSection" style="display:none;">
        <div class="modal-label">üß† Council Learnings</div>
        <div class="modal-content" id="modalLearnings"></div>
      </div>
      <div class="modal-section" id="modalPlanSection">
        <div class="modal-label">üìÑ Plan Document</div>
        <a class="modal-link" id="modalPlanLink" href="#" target="_blank">
          <span>üìÑ</span> <span id="modalPlanName">plan.md</span>
        </a>
      </div>
      <div class="modal-section" id="modalTimelineSection">
        <div class="modal-label">üìÖ Timeline</div>
        <div class="modal-content" id="modalTimeline"></div>
      </div>
      <div class="modal-section" id="modalDiscussionSection">
        <div class="modal-label">üí¨ Discussion / Audit Trail</div>
        <div class="modal-content" id="modalDiscussion" style="max-height:300px;overflow-y:auto;"></div>
        <div style="margin-top:12px;display:flex;gap:8px;">
          <input type="text" id="commentInput" placeholder="Add a comment..." style="flex:1;padding:10px 12px;border:1px solid #30363d;border-radius:6px;background:#161b22;color:#e6edf3;font-size:14px;">
          <button onclick="submitComment()" style="padding:10px 16px;background:#238636;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:500;">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="header">
    <h1><span class="live-dot"></span> Mission Control</h1>
    <div class="status-badge working" id="globalStatus">WORKING</div>
  </div>

  <div class="deadline-banner">
    <span class="deadline-text">üíï Valentine's Day Order Cutoff</span>
    <span class="deadline-days" id="deadlineDays">-- days</span>
  </div>

  <div class="task-board" id="taskBoard">
    <!-- Bot Current -->
    <div class="lane bot-current">
      <div class="lane-header">
        <span class="lane-title">ü§ñ Bot - Working Now</span>
        <span class="lane-count" id="botCurrentCount">0</span>
      </div>
      <div id="botCurrentTasks">Loading...</div>
    </div>

    <!-- Bot Queue -->
    <div class="lane bot-queue">
      <div class="lane-header">
        <span class="lane-title">üìã Bot - Queue</span>
        <span class="lane-count" id="botQueueCount">0</span>
      </div>
      <div id="botQueueTasks">Loading...</div>
    </div>

    <!-- Human Tasks -->
    <div class="lane human">
      <div class="lane-header">
        <span class="lane-title">üë§ Francisco - Your Tasks</span>
        <span class="lane-count" id="humanCount">0</span>
      </div>
      <div id="humanTasks">Loading...</div>
    </div>
  </div>

  <!-- Done Section with Date Filter -->
  <div class="done-section">
    <div class="done-header">
      <div class="done-header-left" onclick="toggleDone()">
        <span class="lane-title">‚úÖ Done <span class="lane-count" id="doneCount">0</span></span>
        <span id="doneToggle">‚ñº Show</span>
      </div>
      <div class="done-date-filter">
        <button class="date-btn" onclick="showDoneDate('yesterday')">Yesterday</button>
        <button class="date-btn active" onclick="showDoneDate('today')">Today</button>
        <input type="date" id="doneDate" class="date-input" onchange="showDoneDate(this.value)">
      </div>
    </div>
    <div class="done-grid collapsed" id="doneTasks"></div>
  </div>

  <!-- Predictions (Reinforcement Learning) -->
  <div class="predictions-section" id="predictionsSection">
    <div class="lane-header" onclick="togglePredictions()" style="cursor:pointer;">
      <span class="lane-title">üéÆ Prediction Game <span class="lane-count" id="predStats">0/0</span></span>
      <span id="predToggle" style="font-size:11px;color:#8b949e;">‚ñº Show</span>
    </div>
    <div class="game-stats collapsed" id="gameStats">
      <div style="display:flex;gap:12px;flex-wrap:wrap;padding:12px;background:rgba(139,92,246,0.08);border-radius:10px;margin-bottom:12px;">
        <div style="text-align:center;min-width:60px;">
          <div style="font-size:20px;font-weight:700;color:#a78bfa;" id="gameLevel">1</div>
          <div style="font-size:9px;color:#8b949e;text-transform:uppercase;">Level</div>
        </div>
        <div style="text-align:center;min-width:60px;">
          <div style="font-size:20px;font-weight:700;color:#fbbf24;" id="gameStreak">0</div>
          <div style="font-size:9px;color:#8b949e;text-transform:uppercase;">üî• Streak</div>
        </div>
        <div style="text-align:center;min-width:60px;">
          <div style="font-size:20px;font-weight:700;color:#3fb950;" id="gameAccuracy">0%</div>
          <div style="font-size:9px;color:#8b949e;text-transform:uppercase;">Accuracy</div>
        </div>
        <div style="text-align:center;min-width:60px;">
          <div style="font-size:20px;font-weight:700;color:#60a5fa;" id="gameToday">0</div>
          <div style="font-size:9px;color:#8b949e;text-transform:uppercase;">Today</div>
        </div>
        <div style="text-align:center;min-width:60px;">
          <div style="font-size:20px;font-weight:700;color:#c9d1d9;" id="gameXP">0</div>
          <div style="font-size:9px;color:#8b949e;text-transform:uppercase;">XP</div>
        </div>
        <div style="text-align:center;min-width:60px;">
          <div style="font-size:20px;font-weight:700;color:#f472b6;" id="gameTotal">0</div>
          <div style="font-size:9px;color:#8b949e;text-transform:uppercase;">Total</div>
        </div>
      </div>
      <div style="font-size:11px;color:#8b949e;text-align:center;margin-top:8px;">
        üß† Every score teaches me. High accuracy = I understand you well!
      </div>
    </div>
    <div class="predictions-grid collapsed" id="predictionsGrid"></div>
    <div class="predictions-history collapsed" id="predictionsHistory">
      <div style="margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.06);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <span style="font-size:12px;color:#8b949e;font-weight:600;">üìú Scoring History</span>
          <button onclick="loadPredictionsHistory()" style="font-size:10px;padding:4px 8px;background:rgba(139,92,246,0.15);border:1px solid rgba(139,92,246,0.3);color:#a78bfa;border-radius:4px;cursor:pointer;">Refresh</button>
        </div>
        <div id="historyList" style="max-height:200px;overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <!-- Trash -->
  <div class="trash-section" id="trashSection" style="display:none;">
    <div class="lane-header">
      <span class="lane-title">üóë Trash <span class="lane-count" id="trashCount">0</span></span>
      <span style="font-size:11px;color:#8b949e;">Auto-empties after 7 days</span>
    </div>
    <div class="trash-grid" id="trashTasks"></div>
  </div>

  <!-- Scheduled -->
  <div class="scheduled-section">
    <div class="lane-header">
      <span class="lane-title">‚è∞ Scheduled (Cron Jobs)</span>
    </div>
    <div class="scheduled-grid" id="scheduledTasks">Loading...</div>
  </div>

  <div class="footer">
    <span>Auto-refreshes every 15 seconds</span>
    <span id="lastUpdate"></span>
  </div>
</div>

<script>
let allTasks = {};  // Store tasks globally for modal access

async function loadTaskBoard() {
  try {
    const resp = await fetch('/api/tasks?' + Date.now());
    const data = await resp.json();

    const tasks = data.tasks || {};
    allTasks = tasks;  // Store for modal
    const lanes = data.lanes || {};

    // Calculate deadline
    const deadline = new Date('2026-02-10');
    const today = new Date();
    const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
    document.getElementById('deadlineDays').textContent = daysLeft + ' days';

    // Render Bot Current
    const botCurrentIds = lanes.bot_current || [];
    document.getElementById('botCurrentCount').textContent = botCurrentIds.length;
    document.getElementById('botCurrentTasks').innerHTML = botCurrentIds.map(id => {
      const t = tasks[id];
      if (!t) return '';
      return renderTask(id, t, 'in-progress');
    }).join('') || '<div style="color:#6e7681;font-size:12px;">No active task</div>';

    // Update global status badge
    const statusBadge = document.getElementById('globalStatus');
    if (botCurrentIds.length > 0) {
      statusBadge.textContent = 'WORKING';
      statusBadge.className = 'status-badge working';
    } else {
      statusBadge.textContent = 'IDLE';
      statusBadge.className = 'status-badge idle';
    }

    // Render Bot Queue
    const botQueueIds = lanes.bot_queue || [];
    document.getElementById('botQueueCount').textContent = botQueueIds.length;
    document.getElementById('botQueueTasks').innerHTML = botQueueIds.map((id, idx) => {
      const t = tasks[id];
      if (!t) return '';
      return renderTask(id, t, 'pending', idx === 0 ? 'NEXT' : null, {index: idx, total: botQueueIds.length});
    }).join('') || '<div style="color:#8b949e;font-size:13px;">Queue empty üéâ</div>';

    // Render Human Tasks
    const humanIds = lanes.human || [];
    document.getElementById('humanCount').textContent = humanIds.length;
    document.getElementById('humanTasks').innerHTML = humanIds.map(id => {
      const t = tasks[id];
      if (!t) return '';
      return renderTask(id, t, 'human-task');
    }).join('') || '<div style="color:#8b949e;font-size:13px;">All done! üéâ</div>';

    // Store lanes for filtering
    currentLanes = lanes;

    // Render Done with date filter
    renderDoneTasks();

    // Render Trash
    const trashIds = lanes.trash || [];
    const trashSection = document.getElementById('trashSection');
    if (trashIds.length > 0) {
      trashSection.style.display = 'block';
      document.getElementById('trashCount').textContent = trashIds.length;
      document.getElementById('trashTasks').innerHTML = trashIds.map(id => {
        const t = tasks[id];
        if (!t) return '';
        const deletedDate = t.deleted_at ? new Date(t.deleted_at).toLocaleDateString() : '';
        return `
          <div class="trash-item">
            <span class="trash-item-title">${t.title}</span>
            <span class="trash-item-date">${deletedDate}</span>
            <button class="restore-btn" onclick="restoreTask('${id}')">‚Ü© Restore</button>
            <button class="perma-delete-btn" onclick="permanentDelete('${id}')" title="Delete forever">‚úï</button>
          </div>
        `;
      }).join('');
    } else {
      trashSection.style.display = 'none';
    }

    // Render Scheduled (Cron Jobs)
    const schedIds = lanes.scheduled || [];
    document.getElementById('scheduledTasks').innerHTML = schedIds.map(id => {
      const t = tasks[id];
      if (!t) return '';
      return `
        <div class="scheduled-item">
          <div class="scheduled-content" onclick="showCronDetail('${id}')">
            <div class="scheduled-title">${t.title}</div>
            <div class="scheduled-time">‚è∞ ${t.schedule || ''}</div>
            <div class="scheduled-next">${t.nextRun ? 'Next: ' + new Date(t.nextRun).toLocaleString() : ''}</div>
          </div>
          <button class="delete-btn scheduled-delete" onclick="event.stopPropagation(); deleteCron('${id}', event)" title="Remove">‚úï</button>
        </div>
      `;
    }).join('') || '<div style="color:#8b949e;">No scheduled tasks</div>';

    document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();

  } catch(e) {
    console.error('Failed to load tasks:', e);
    document.getElementById('botCurrentTasks').innerHTML = '<div style="color:#f85149;">Failed to load tasks.json</div>';
  }
}

function renderTask(id, task, statusClass, badge, queueInfo) {
  const planLink = task.plan ? `<span class="task-plan">üìÑ ${task.plan.split('/').pop()}</span>` : '';
  const estimate = task.estimate ? `<span class="task-estimate">‚è± ${task.estimate}</span>` : '';

  // Check for verification badge (human-completed task awaiting bot verification)
  let badgeHtml = '';
  if (task.needs_verification) {
    badgeHtml = `<span class="task-estimate" style="background:#7c3aed;color:#fff;">üîç VERIFY</span>`;
  } else if (badge) {
    badgeHtml = `<span class="task-estimate" style="background:#238636;color:#fff;">${badge}</span>`;
  }

  // Step progress indicator
  let stepProgress = '';
  if (task.steps && task.steps.length > 0) {
    const currentStep = task.current_step || 0;
    const doneSteps = task.steps.filter(s => s.status === 'done').length;
    const totalSteps = task.steps.length;
    const currentStepInfo = task.steps[currentStep];
    const stepStatus = currentStepInfo ? currentStepInfo.status : 'pending';

    let stepIcon = 'üìã';
    let stepColor = '#8b949e';
    if (stepStatus === 'waiting') {
      stepIcon = '‚è≥';
      stepColor = '#d29922';
    } else if (stepStatus === 'in_progress') {
      stepIcon = '‚ö°';
      stepColor = '#f0883e';
    } else if (stepStatus === 'blocked') {
      stepIcon = 'üö´';
      stepColor = '#f85149';
    }

    stepProgress = `<span class="task-estimate" style="background:rgba(88,166,255,0.15);color:${stepColor};">${stepIcon} Step ${currentStep + 1}/${totalSteps}</span>`;
  }

  // Mark Complete button for human tasks
  const completeBtn = statusClass === 'human-task'
    ? `<button class="complete-btn" onclick="event.stopPropagation(); requestComplete('${id}', this)">‚úì Mark Complete</button>`
    : '';

  // Transfer buttons - move between lanes
  let transferBtn = '';
  if (statusClass === 'human-task') {
    transferBtn = `<button class="transfer-btn" onclick="event.stopPropagation(); transferTask('${id}', 'human', 'bot_queue')" title="Move to Bot Queue">ü§ñ‚Üê</button>`;
  } else if (statusClass === 'in-progress') {
    // Pause button - move from Working back to Queue
    transferBtn = `<button class="transfer-btn pause-btn" onclick="event.stopPropagation(); transferTask('${id}', 'bot_current', 'bot_queue')" title="Pause - Move back to Queue">‚ùö‚ùö</button>`;
  } else if (queueInfo) {
    transferBtn = `<button class="transfer-btn" onclick="event.stopPropagation(); transferTask('${id}', 'bot_queue', 'human')" title="Move to Human Tasks">‚Üíüë§</button>`;
  }

  // Reorder buttons for queue tasks
  let reorderBtns = '';
  if (queueInfo) {
    const upDisabled = queueInfo.index === 0 ? 'disabled' : '';
    const downDisabled = queueInfo.index === queueInfo.total - 1 ? 'disabled' : '';
    reorderBtns = `
      <div class="reorder-controls">
        <button class="reorder-btn" ${upDisabled} onclick="event.stopPropagation(); reorderTask('${id}', 'up')" title="Move up">‚ñ≤</button>
        <button class="reorder-btn" ${downDisabled} onclick="event.stopPropagation(); reorderTask('${id}', 'down')" title="Move down">‚ñº</button>
      </div>
    `;
  }

  // Delete button for all tasks
  const deleteBtn = `<button class="delete-btn" onclick="event.stopPropagation(); deleteTask('${id}', event)" title="Remove task">‚úï</button>`;

  // Build toolbar with all action buttons
  let toolbar = '';
  const hasActions = completeBtn || transferBtn || reorderBtns || deleteBtn;
  if (hasActions) {
    toolbar = `<div class="task-toolbar">${completeBtn}${transferBtn}${reorderBtns}${deleteBtn}</div>`;
  }

  return `
    <div class="task-item ${statusClass}" onclick="showTaskDetail('${id}')">
      <div class="task-id">${id}</div>
      <div class="task-title-text">${task.title}</div>
      <div class="task-meta">
        ${stepProgress}
        ${planLink}
        ${estimate}
        ${badgeHtml}
        ${toolbar}
      </div>
    </div>
  `;
}

function showTaskDetail(id) {
  const task = allTasks[id];
  if (!task) return;

  document.getElementById('modalTitle').textContent = task.title;
  document.getElementById('modalId').textContent = id;

  // Status
  const statusEl = document.getElementById('modalStatus');
  const status = task.status || 'pending';
  statusEl.textContent = status;
  statusEl.className = 'modal-status ' + (status === 'done' ? 'done' : status === 'in_progress' ? 'in-progress' : 'pending');

  // Context (the WHY)
  const contextSection = document.getElementById('modalContextSection');
  if (task.context && (task.context.summary || task.context.why_exists)) {
    let contextHtml = '';

    // Why it exists (priority display for cron tasks)
    if (task.context.why_exists) {
      contextHtml += '<div style="margin-bottom:12px;padding:10px;background:rgba(136,192,208,0.15);border-radius:6px;border-left:3px solid #88c0d0;">';
      contextHtml += '<strong>‚ùì Why This Exists:</strong><br>' + task.context.why_exists;
      contextHtml += '</div>';
    }

    // Benefit to you (priority display for cron tasks)
    if (task.context.benefit_to_you) {
      contextHtml += '<div style="margin-bottom:12px;padding:10px;background:rgba(163,190,140,0.15);border-radius:6px;border-left:3px solid #a3be8c;">';
      contextHtml += '<strong>‚úÖ Benefit To You:</strong><br>' + task.context.benefit_to_you;
      contextHtml += '</div>';
    }

    // Schedule if present
    if (task.context.schedule) {
      contextHtml += '<div style="margin-bottom:12px;font-size:13px;"><strong>‚è∞ Schedule:</strong> ' + task.context.schedule + '</div>';
    }

    // Summary (fallback or additional)
    if (task.context.summary && !task.context.why_exists) {
      contextHtml += task.context.summary;
    }

    // Add decisions if present
    if (task.context.decisions && task.context.decisions.length > 0) {
      contextHtml += '<div style="margin-top:12px;font-size:12px;"><strong>Key Decisions:</strong><ul style="margin:4px 0 0 16px;">';
      task.context.decisions.forEach(d => {
        contextHtml += '<li>' + d + '</li>';
      });
      contextHtml += '</ul></div>';
    }
    // Add constraints if present
    if (task.context.constraints && task.context.constraints.length > 0) {
      contextHtml += '<div style="margin-top:8px;font-size:12px;"><strong>Constraints:</strong><ul style="margin:4px 0 0 16px;">';
      task.context.constraints.forEach(c => {
        contextHtml += '<li>' + c + '</li>';
      });
      contextHtml += '</ul></div>';
    }
    document.getElementById('modalContext').innerHTML = contextHtml;
    contextSection.style.display = 'block';
  } else {
    contextSection.style.display = 'none';
  }

  // Steps Progress
  const stepsSection = document.getElementById('modalStepsSection');
  if (task.steps && task.steps.length > 0) {
    const currentStep = task.current_step || 0;
    let stepsHtml = '<div style="display:flex;flex-direction:column;gap:8px;">';
    task.steps.forEach((step, idx) => {
      let icon, color, bgColor;
      switch(step.status) {
        case 'done':
          icon = '‚úÖ'; color = '#3fb950'; bgColor = 'rgba(63,185,80,0.1)';
          break;
        case 'in_progress':
          icon = '‚ö°'; color = '#f0883e'; bgColor = 'rgba(240,136,62,0.1)';
          break;
        case 'waiting':
          icon = '‚è≥'; color = '#d29922'; bgColor = 'rgba(210,153,34,0.1)';
          break;
        case 'blocked':
          icon = 'üö´'; color = '#f85149'; bgColor = 'rgba(248,81,73,0.1)';
          break;
        default:
          icon = '‚¨ú'; color = '#8b949e'; bgColor = 'transparent';
      }
      const isCurrent = idx === currentStep && step.status !== 'done';
      const border = isCurrent ? 'border: 1px solid ' + color + ';' : '';
      let stepInfo = step.step;
      if (step.waiting_for) {
        stepInfo += '<div style="font-size:11px;color:#d29922;margin-top:4px;">‚è≥ Waiting for: ' + step.waiting_for + '</div>';
      }
      if (step.completed_at) {
        const completedTime = new Date(step.completed_at).toLocaleString();
        stepInfo += '<div style="font-size:10px;color:#8b949e;margin-top:2px;">‚úì ' + completedTime + '</div>';
      }
      stepsHtml += `
        <div style="display:flex;gap:10px;padding:8px;border-radius:6px;background:${bgColor};${border}">
          <span style="font-size:16px;">${icon}</span>
          <div style="flex:1;">
            <div style="color:${step.status === 'done' ? '#8b949e' : '#e6edf3'};${step.status === 'done' ? 'text-decoration:line-through;' : ''}">${stepInfo}</div>
          </div>
          <span style="font-size:11px;color:#8b949e;">${idx + 1}/${task.steps.length}</span>
        </div>
      `;
    });
    stepsHtml += '</div>';
    // Add retry count if exists
    if (task.retry_count && task.retry_count > 0) {
      stepsHtml += `<div style="margin-top:8px;font-size:11px;color:#f85149;">‚ö†Ô∏è Retry count: ${task.retry_count}/3</div>`;
    }
    document.getElementById('modalSteps').innerHTML = stepsHtml;
    stepsSection.style.display = 'block';
  } else {
    stepsSection.style.display = 'none';
  }

  // Approach
  const approachSection = document.getElementById('modalApproachSection');
  if (task.approach) {
    document.getElementById('modalApproach').textContent = task.approach;
    approachSection.style.display = 'block';
  } else {
    approachSection.style.display = 'none';
  }

  // Notes
  const notesSection = document.getElementById('modalNotesSection');
  if (task.notes) {
    document.getElementById('modalNotes').textContent = task.notes;
    notesSection.style.display = 'block';
  } else {
    notesSection.style.display = 'none';
  }

  // Learnings (for Council tasks)
  const learningsSection = document.getElementById('modalLearningsSection');
  if (task.learnings) {
    let learningsHtml = '';
    if (task.learnings.question) {
      learningsHtml += '<div style="margin-bottom:12px;"><strong>Question:</strong> ' + task.learnings.question + '</div>';
    }
    if (task.learnings.verdict) {
      learningsHtml += '<div style="margin-bottom:12px;padding:10px;background:rgba(163,113,247,0.15);border-radius:6px;border-left:3px solid #a371f7;"><strong>Verdict:</strong> ' + task.learnings.verdict + '</div>';
    }
    if (task.learnings.outcomes && task.learnings.outcomes.length > 0) {
      learningsHtml += '<div style="margin-bottom:8px;"><strong>Outcomes:</strong><ul style="margin:4px 0 0 16px;">';
      task.learnings.outcomes.forEach(function(o) { learningsHtml += '<li>' + o + '</li>'; });
      learningsHtml += '</ul></div>';
    }
    if (task.learnings.actionsTaken && task.learnings.actionsTaken.length > 0) {
      learningsHtml += '<div><strong>Actions Taken:</strong><ul style="margin:4px 0 0 16px;">';
      task.learnings.actionsTaken.forEach(function(a) { learningsHtml += '<li>' + a + '</li>'; });
      learningsHtml += '</ul></div>';
    }
    document.getElementById('modalLearnings').innerHTML = learningsHtml;
    learningsSection.style.display = 'block';
  } else {
    learningsSection.style.display = 'none';
  }

  // Plan link
  const planSection = document.getElementById('modalPlanSection');
  if (task.plan) {
    document.getElementById('modalPlanLink').href = '../' + task.plan;
    document.getElementById('modalPlanName').textContent = task.plan;
    planSection.style.display = 'block';
  } else {
    planSection.style.display = 'none';
  }

  // Timeline (created + completed)
  const timelineSection = document.getElementById('modalTimelineSection');
  let timelineHtml = '';
  if (task.created) {
    const createdDate = new Date(task.created).toLocaleString();
    timelineHtml += `<div style="margin-bottom:8px;">üìù <strong>Created:</strong> ${createdDate}</div>`;
    timelineHtml += `<div style="font-size:11px;color:#8b949e;margin-bottom:8px;">‚Üë Find this time in Telegram to see original conversation</div>`;
  }
  if (task.completed) {
    const completedDate = new Date(task.completed).toLocaleString();
    timelineHtml += `<div>‚úÖ <strong>Completed:</strong> ${completedDate}</div>`;
    // Calculate duration if both exist
    if (task.created) {
      const duration = new Date(task.completed) - new Date(task.created);
      const hours = Math.floor(duration / (1000 * 60 * 60));
      const mins = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
      if (hours > 0 || mins > 0) {
        timelineHtml += `<div style="margin-top:8px;color:#8b949e;">‚è± Duration: ${hours > 0 ? hours + 'h ' : ''}${mins}m</div>`;
      }
    }
  }
  if (timelineHtml) {
    document.getElementById('modalTimeline').innerHTML = timelineHtml;
    timelineSection.style.display = 'block';
  } else {
    timelineSection.style.display = 'none';
  }

  // Discussion / Audit Trail
  const discussionSection = document.getElementById('modalDiscussionSection');
  const discussionEl = document.getElementById('modalDiscussion');
  if (task.discussion && task.discussion.length > 0) {
    let discussionHtml = '';
    task.discussion.forEach((msg, idx) => {
      const time = msg.ts ? new Date(msg.ts).toLocaleString() : '';
      const isHuman = msg.author === 'human';
      const authorIcon = isHuman ? 'üë§' : 'ü§ñ';
      const authorName = isHuman ? 'Francisco' : 'Bot';
      const bgColor = isHuman ? 'rgba(56,139,253,0.1)' : 'rgba(139,148,158,0.1)';
      const borderColor = isHuman ? '#388bfd' : '#8b949e';
      const isCrossedOut = msg.crossed_out === true;
      const strikeStyle = isCrossedOut ? 'text-decoration:line-through;opacity:0.5;' : '';
      const btnText = isCrossedOut ? '‚Ü©Ô∏è' : '‚úï';
      const btnTitle = isCrossedOut ? 'Restore' : 'Cross out';
      discussionHtml += `
        <div style="margin-bottom:10px;padding:10px;background:${bgColor};border-left:3px solid ${borderColor};border-radius:4px;${strikeStyle}">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span style="font-weight:500;">${authorIcon} ${authorName}</span>
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-size:11px;color:#8b949e;">${time}</span>
              <button onclick="toggleCrossOut('${id}', ${idx})" title="${btnTitle}" style="background:none;border:none;cursor:pointer;font-size:12px;opacity:0.6;padding:2px 4px;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.6">${btnText}</button>
            </div>
          </div>
          <div style="font-size:13px;white-space:pre-wrap;">${msg.message}</div>
        </div>
      `;
    });
    discussionEl.innerHTML = discussionHtml;
    discussionSection.style.display = 'block';
    // Scroll to bottom of discussion
    discussionEl.scrollTop = discussionEl.scrollHeight;
  } else {
    discussionEl.innerHTML = '<div style="color:#8b949e;font-style:italic;">No discussion yet. Add a comment to start the audit trail.</div>';
    discussionSection.style.display = 'block';
  }

  // Store current task ID for comment submission
  window.currentTaskId = id;

  document.getElementById('taskModal').classList.add('active');
}

function closeModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('taskModal').classList.remove('active');
}

async function submitComment() {
  const input = document.getElementById('commentInput');
  const message = input.value.trim();
  if (!message || !window.currentTaskId) return;

  const taskId = window.currentTaskId;
  
  try {
    const response = await fetch('/api/task-comment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ taskId, message })
    });
    
    if (response.ok) {
      input.value = '';
      // Refresh task data and re-render
      await loadTaskBoard();
      showTaskDetail(taskId);
      showToast('Comment added');
    } else {
      showToast('Failed to add comment', true);
    }
  } catch (err) {
    console.error('Comment error:', err);
    showToast('Failed to add comment', true);
  }
}

async function toggleCrossOut(taskId, commentIdx) {
  try {
    const response = await fetch('/api/toggle-crossout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ taskId, commentIdx })
    });
    
    if (response.ok) {
      // Refresh task data and re-render
      await loadTaskBoard();
      showTaskDetail(taskId);
    } else {
      showToast('Failed to toggle strikethrough', true);
    }
  } catch (err) {
    console.error('Toggle crossout error:', err);
    showToast('Failed to toggle strikethrough', true);
  }
}

let currentDoneFilter = 'today';

function toggleDone() {
  const grid = document.getElementById('doneTasks');
  const toggle = document.getElementById('doneToggle');
  if (grid.classList.contains('collapsed')) {
    grid.classList.remove('collapsed');
    toggle.textContent = '‚ñ≤ Hide';
  } else {
    grid.classList.add('collapsed');
    toggle.textContent = '‚ñº Show';
  }
}

// === PREDICTIONS (Reinforcement Learning) ===
let predictionsData = null;

function togglePredictions() {
  const grid = document.getElementById('predictionsGrid');
  const history = document.getElementById('predictionsHistory');
  const gameStats = document.getElementById('gameStats');
  const toggle = document.getElementById('predToggle');
  if (grid.classList.contains('collapsed')) {
    grid.classList.remove('collapsed');
    history.classList.remove('collapsed');
    gameStats.classList.remove('collapsed');
    toggle.textContent = '‚ñ≤ Hide';
    loadPredictions();
    loadPredictionsHistory();
  } else {
    grid.classList.add('collapsed');
    history.classList.add('collapsed');
    gameStats.classList.add('collapsed');
    toggle.textContent = '‚ñº Show';
  }
}

async function loadPredictions() {
  try {
    const resp = await fetch('/api/predictions?' + Date.now());
    predictionsData = await resp.json();
    renderPredictions();
  } catch (e) {
    document.getElementById('predictionsGrid').innerHTML = '<div style="color:#f87171;">Failed to load predictions</div>';
  }
}

function renderPredictions() {
  if (!predictionsData) return;
  
  const stats = predictionsData.stats || {correct: 0, wrong: 0, pending: 0};
  document.getElementById('predStats').textContent = `‚úì${stats.correct} ‚úó${stats.wrong} ‚è≥${stats.pending}`;
  
  // Update game stats
  const game = predictionsData.game || {};
  document.getElementById('gameLevel').textContent = game.level || 1;
  document.getElementById('gameStreak').textContent = game.streak || 0;
  document.getElementById('gameAccuracy').textContent = (game.accuracy || 0) + '%';
  document.getElementById('gameToday').textContent = game.today_scored || 0;
  document.getElementById('gameXP').textContent = game.xp || 0;
  document.getElementById('gameTotal').textContent = game.total_scored || 0;
  
  const preds = predictionsData.predictions || [];
  const grid = document.getElementById('predictionsGrid');
  
  // Group by category
  const byCategory = {priority: [], behavior: [], decision: []};
  preds.forEach(p => {
    if (byCategory[p.category]) byCategory[p.category].push(p);
  });
  
  let html = '';
  for (const [cat, items] of Object.entries(byCategory)) {
    if (items.length === 0) continue;
    const catEmoji = cat === 'priority' ? 'üéØ' : cat === 'behavior' ? '‚è∞' : 'üß≠';
    html += `<div style="grid-column:1/-1;font-size:11px;color:#8b949e;text-transform:uppercase;margin-top:8px;">${catEmoji} ${cat}</div>`;
    items.forEach(p => {
      const scoreClass = p.score === 'correct' ? 'scored-correct' : p.score === 'wrong' ? 'scored-wrong' : '';
      const correctActive = p.score === 'correct' ? 'active' : '';
      const wrongActive = p.score === 'wrong' ? 'active' : '';
      html += `
        <div class="prediction-card ${scoreClass}">
          <div class="prediction-header">
            <span class="prediction-id">${p.id}</span>
            <span class="prediction-confidence ${p.confidence}">${p.confidence}</span>
          </div>
          <div class="prediction-text">${p.prediction}</div>
          <div class="prediction-rationale">${p.rationale}</div>
          <div class="prediction-actions">
            <button class="score-btn correct ${correctActive}" onclick="scorePrediction('${p.id}', 'correct')">‚úì Correct</button>
            <button class="score-btn wrong ${wrongActive}" onclick="scorePrediction('${p.id}', 'wrong')">‚úó Wrong</button>
          </div>
        </div>
      `;
    });
  }
  
  grid.innerHTML = html || '<div style="color:#6e7681;">No predictions yet</div>';
}

async function scorePrediction(id, score) {
  try {
    const resp = await fetch('/api/score-prediction', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({id, score})
    });
    const result = await resp.json();
    if (result.ok) {
      // Update local data and re-render
      const pred = predictionsData.predictions.find(p => p.id === id);
      if (pred) {
        pred.score = score;
        pred.scored_at = new Date().toISOString();
      }
      predictionsData.stats = result.stats;
      renderPredictions();
      loadPredictionsHistory(); // Refresh history
    }
  } catch (e) {
    console.error('Failed to score prediction:', e);
  }
}

async function loadPredictionsHistory() {
  try {
    const resp = await fetch('/api/predictions-history?' + Date.now());
    const data = await resp.json();
    const entries = data.entries || [];
    
    const list = document.getElementById('historyList');
    if (entries.length === 0) {
      list.innerHTML = '<div style="color:#6e7681;font-size:11px;padding:8px;">No scores yet. Click ‚úì or ‚úó on predictions above!</div>';
      return;
    }
    
    let html = '';
    for (const e of entries.slice(0, 50)) { // Show last 50
      if (e.event === 'score') {
        const scoreClass = e.score === 'correct' ? 'score-correct' : 'score-wrong';
        const scoreIcon = e.score === 'correct' ? '‚úì' : '‚úó';
        html += `
          <div class="history-item">
            <span class="date">${e.date} ${e.time || ''}</span>
            <span class="pred-id">${e.prediction_id}</span>
            <span class="${scoreClass}">${scoreIcon} ${e.score}</span>
          </div>
        `;
      } else if (e.event === 'system_created') {
        html += `
          <div class="history-item">
            <span class="date">${e.date}</span>
            <span class="note">üöÄ ${e.note || 'System created'}</span>
          </div>
        `;
      }
    }
    list.innerHTML = html;
  } catch (e) {
    document.getElementById('historyList').innerHTML = '<div style="color:#f87171;">Failed to load history</div>';
  }
}

function showDoneDate(filter) {
  currentDoneFilter = filter;

  // Update button states
  document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
  if (filter === 'today') {
    document.querySelector('.date-btn:nth-child(2)').classList.add('active');
  } else if (filter === 'yesterday') {
    document.querySelector('.date-btn:nth-child(1)').classList.add('active');
  }

  renderDoneTasks();
}

function getDateString(date) {
  return date.toISOString().split('T')[0];
}

function renderDoneTasks() {
  const doneIds = currentLanes.done_today || [];

  let filterDate;
  const now = new Date();

  if (currentDoneFilter === 'today') {
    filterDate = getDateString(now);
  } else if (currentDoneFilter === 'yesterday') {
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    filterDate = getDateString(yesterday);
  } else {
    filterDate = currentDoneFilter; // Custom date from picker
  }

  // Filter tasks by completion date
  const filteredIds = doneIds.filter(id => {
    const task = allTasks[id];
    if (!task || !task.completed) return currentDoneFilter === 'today'; // Show if no date and viewing today
    const completedDate = task.completed.split('T')[0];
    return completedDate === filterDate;
  });

  document.getElementById('doneCount').textContent = filteredIds.length;
  document.getElementById('doneTasks').innerHTML = filteredIds.map(id => {
    const t = allTasks[id];
    if (!t) return '';
    return `<div class="done-item" onclick="showTaskDetail('${id}')" style="cursor:pointer;"><span class="check">‚úì</span>${t.title}</div>`;
  }).join('') || `<div class="done-item">Nothing completed on ${filterDate}</div>`;
}

let currentLanes = {};

loadTaskBoard();

// Smart auto-refresh: only refresh when modal is NOT open
setInterval(() => {
  const modal = document.getElementById('taskModal');
  const isModalOpen = modal && modal.classList.contains('active');
  if (!isModalOpen) {
    loadTaskBoard();
  }
  // If modal is open, skip refresh to preserve user's work
}, 15000);

// Delete task/cron with custom confirm bubble
let pendingDeleteId = null;
let pendingDeleteType = 'task'; // 'task' or 'cron'

function deleteCron(cronId, event) {
  pendingDeleteType = 'cron';
  deleteTask(cronId, event);
}

function deleteTask(taskId, event) {
  // Close any existing bubble
  cancelDelete();

  pendingDeleteId = taskId;
  const task = allTasks[taskId];
  const title = task ? task.title : taskId;

  const bubble = document.getElementById('confirmBubble');
  document.getElementById('confirmTitle').textContent = `Delete this task?`;
  document.getElementById('confirmMessage').innerHTML = `<strong>${taskId}</strong><br>${title}`;

  // Position near the clicked button
  const btn = event.target.closest('.delete-btn');
  const rect = btn.getBoundingClientRect();

  bubble.style.top = (rect.bottom + 10) + 'px';
  bubble.style.left = (rect.right - 220) + 'px';

  // Keep on screen
  if (parseInt(bubble.style.left) < 10) {
    bubble.style.left = '10px';
  }

  bubble.classList.add('active');

  // Close when clicking outside
  setTimeout(() => {
    document.addEventListener('click', closeOnClickOutside);
  }, 10);
}

function closeOnClickOutside(e) {
  const bubble = document.getElementById('confirmBubble');
  if (!bubble.contains(e.target) && !e.target.closest('.delete-btn')) {
    cancelDelete();
  }
}

function cancelDelete() {
  pendingDeleteId = null;
  document.getElementById('confirmBubble').classList.remove('active');
  document.removeEventListener('click', closeOnClickOutside);
}

async function confirmDelete() {
  const itemId = pendingDeleteId;
  const isCron = pendingDeleteType === 'cron';
  document.getElementById('confirmBubble').classList.remove('active');
  document.removeEventListener('click', closeOnClickOutside);

  if (!itemId) return;

  try {
    const endpoint = isCron ? '/api/delete-cron' : '/api/delete-task';
    const bodyData = isCron ? { cronId: itemId } : { taskId: itemId };
    const resp = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(bodyData)
    });
    const data = await resp.json();

    if (data.success) {
      showToast(`üóë ${itemId} removed`);
      loadTaskBoard();
    } else {
      showToast(`Error: ${data.error || 'Failed to delete'}`, 'error');
    }
  } catch(e) {
    showToast('Failed to delete', 'error');
  }
  pendingDeleteId = null;
  pendingDeleteType = 'task';
}

// Restore task from trash
async function restoreTask(taskId) {
  try {
    const resp = await fetch('/api/restore-task', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ taskId })
    });
    const data = await resp.json();

    if (data.success) {
      showToast(`‚Ü© ${taskId} restored to ${data.restoredTo}`);
      loadTaskBoard();
    } else {
      showToast(`Error: ${data.error}`, 'error');
    }
  } catch(e) {
    showToast('Failed to restore', 'error');
  }
}

// Permanent delete from trash
async function permanentDelete(taskId) {
  if (!confirm(`Permanently delete ${taskId}? This cannot be undone.`)) return;

  try {
    const resp = await fetch('/api/permanent-delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ taskId })
    });
    const data = await resp.json();

    if (data.success) {
      showToast(`üóë ${taskId} permanently deleted`);
      loadTaskBoard();
    } else {
      showToast(`Error: ${data.error}`, 'error');
    }
  } catch(e) {
    showToast('Failed to delete', 'error');
  }
}

// Transfer task between lanes
async function transferTask(taskId, fromLane, toLane) {
  try {
    const resp = await fetch('/api/transfer-task', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ taskId, fromLane, toLane })
    });
    const data = await resp.json();

    if (data.success) {
      const icon = toLane === 'bot_queue' ? 'ü§ñ' : 'üë§';
      showToast(`${icon} ${taskId} moved to ${toLane === 'bot_queue' ? 'Bot Queue' : 'Human Tasks'}`);
      loadTaskBoard();
    } else {
      showToast(`Error: ${data.error || 'Failed to transfer'}`, 'error');
    }
  } catch(e) {
    showToast('Failed to transfer task', 'error');
  }
}

// Reorder task in queue
async function reorderTask(taskId, direction) {
  try {
    const resp = await fetch('/api/reorder-task', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ taskId, direction })
    });
    const data = await resp.json();

    if (data.success) {
      showToast(`${direction === 'up' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è'} ${taskId} moved ${direction}`);
      loadTaskBoard(); // Refresh the board
    } else {
      showToast(`Error: ${data.error || 'Failed to reorder'}`, 'error');
    }
  } catch(e) {
    showToast('Failed to reorder task', 'error');
  }
}

// Request task completion verification
async function requestComplete(taskId, btn) {
  btn.disabled = true;
  btn.textContent = '‚è≥ Verifying...';
  btn.classList.add('pending');

  try {
    const resp = await fetch('/api/request-complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ taskId })
    });
    const data = await resp.json();

    if (data.success) {
      // Human verification is final - task goes directly to done
      btn.textContent = '‚úÖ Done!';
      showToast(`‚úÖ ${taskId} marked complete!`);
      setTimeout(() => loadTasks(), 500);
    } else {
      btn.textContent = '‚ùå Error';
      btn.classList.remove('pending');
      showToast(`Error: ${data.error || 'Unknown error'}`, 'error');
      setTimeout(() => {
        btn.textContent = '‚úì Mark Complete';
        btn.disabled = false;
      }, 2000);
    }
  } catch(e) {
    btn.textContent = '‚ùå Failed';
    btn.classList.remove('pending');
    showToast('Failed to send request', 'error');
    setTimeout(() => {
      btn.textContent = '‚úì Mark Complete';
      btn.disabled = false;
    }, 2000);
  }
}

// Toast notification
function showToast(message, type = 'info') {
  // Remove existing toast
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${type === 'error' ? '#f85149' : '#238636'};
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 2000;
    animation: slideUp 0.3s ease;
    max-width: 90%;
    text-align: center;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

// Cron modal functions
let currentCronId = null;

// Cron job summaries (plain English descriptions)
const cronSummaries = {
  'CRON-research': 'üîç <strong>Daily AI Research Brief</strong><br><br>Every morning at 9 AM, I scan Twitter/X for the latest AI news, agent developments, Claude updates, and tips from experts. I compile a brief of the most important findings so you stay current on AI trends without having to scroll through feeds yourself.',
  'CRON-curiosity': 'üß† <strong>Curiosity Engine</strong><br><br>At 9 PM each night, I look for opportunities to improve the business - competitor moves, seasonal trends, new product ideas, marketing angles. I research and document findings so we always have fresh ideas in the pipeline.',
  'CRON-learn': 'üìö <strong>Compound Loop: LEARN</strong><br><br>At 10:30 PM, I review what happened today - what worked, what failed, what we learned. I extract lessons and add them to our knowledge base so we keep getting smarter and don\'t repeat mistakes.',
  'CRON-ship': 'üöÄ <strong>Compound Loop: SHIP</strong><br><br>Late night, I check the backlog for tasks that are ready to execute autonomously. If something is safe to do without approval (like SEO fixes, drafts, research), I do it overnight so you wake up to completed work.',
  'CRON-backup': 'üíæ <strong>Daily Git Backup</strong><br><br>At 11 PM, I automatically commit all workspace changes to GitHub. This ensures nothing is ever lost and we have a full history of everything we\'ve done.',
  'CRON-consolidation': 'üì¶ <strong>Memory Consolidation</strong><br><br>At 3 AM, I clean up and organize the day\'s memory files. I extract the important stuff into the knowledge base, generate the recall pack for tomorrow, and archive raw logs. Keeps the system fast and focused.'
};

function showCronDetail(id) {
  currentCronId = id;
  const cron = allTasks[id];
  if (!cron) return;

  document.getElementById('cronModalTitle').textContent = cron.title;
  document.getElementById('cronModalId').textContent = id;
  document.getElementById('cronSchedule').value = cron.schedule || '';
  document.getElementById('cronPlan').value = cron.plan || '';

  // Show summary
  const summary = cronSummaries[id] || cron.description || 'No description available. Add one by editing the cron job.';
  document.getElementById('cronSummary').innerHTML = summary;

  if (cron.nextRun) {
    const dt = new Date(cron.nextRun);
    const local = new Date(dt.getTime() - dt.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('cronNextRun').value = local;
  } else {
    document.getElementById('cronNextRun').value = '';
  }

  // Hide plan file content until requested
  document.getElementById('planFileSection').style.display = 'none';

  document.getElementById('cronModal').classList.add('active');
}

async function viewPlanFile() {
  const planPath = document.getElementById('cronPlan').value;
  if (!planPath) {
    showToast('No plan file specified', 'error');
    return;
  }

  try {
    const resp = await fetch('/api/read-file', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path: planPath })
    });
    const data = await resp.json();

    if (data.success) {
      document.getElementById('planFileContent').textContent = data.content;
      document.getElementById('planFileSection').style.display = 'block';
    } else {
      showToast(`Error: ${data.error}`, 'error');
    }
  } catch(e) {
    showToast('Failed to read file', 'error');
  }
}

function closeCronModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('cronModal').classList.remove('active');
  currentCronId = null;
}

async function saveCronChanges() {
  if (!currentCronId) return;

  const schedule = document.getElementById('cronSchedule').value;
  const plan = document.getElementById('cronPlan').value;
  const nextRunInput = document.getElementById('cronNextRun').value;
  const nextRun = nextRunInput ? new Date(nextRunInput).toISOString() : null;

  try {
    const resp = await fetch('/api/update-cron', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cronId: currentCronId, schedule, plan, nextRun })
    });
    const data = await resp.json();

    if (data.success) {
      showToast(`‚úÖ ${currentCronId} updated`);
      closeCronModal();
      loadTaskBoard();
    } else {
      showToast(`Error: ${data.error}`, 'error');
    }
  } catch(e) {
    showToast('Failed to save changes', 'error');
  }
}

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal();
    closeCronModal();
  }
});
</script>
</body>
</html>
